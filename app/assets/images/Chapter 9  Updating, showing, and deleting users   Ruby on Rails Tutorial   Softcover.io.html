<!DOCTYPE html>
<!-- saved from url=(0061)http://www.railstutorial.org/book/updating_and_deleting_users -->
<html id="custDomain"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/6713.js" async="" type="text/javascript"></script><script async="" src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/analytics.js"></script><script type="text/javascript">window.NREUM||(NREUM={});NREUM.info={"beacon":"beacon-2.newrelic.com","errorBeacon":"bam.nr-data.net","licenseKey":"1310fd97f1","applicationID":"4014257","transactionName":"IVZWR0tbWF4BFxhWVw1SSxxaQUdGCwhoRl0DXQ==","queueTime":15,"applicationTime":124,"ttGuid":"","agentToken":null,"agent":"js-agent.newrelic.com/nr-411.min.js"}</script>
<script type="text/javascript">window.NREUM||(NREUM={}),__nr_require=function(t,n,e){function r(e){if(!n[e]){var o=n[e]={exports:{}};t[e][0].call(o.exports,function(n){var o=t[e][1][n];return r(o?o:n)},o,o.exports)}return n[e].exports}if("function"==typeof __nr_require)return __nr_require;for(var o=0;o<e.length;o++)r(e[o]);return r}({D5DuLP:[function(t,n){function e(t,n){var e=r[t];return e?e.apply(this,n):(o[t]||(o[t]=[]),void o[t].push(n))}var r={},o={};n.exports=e,e.queues=o,e.handlers=r},{}],handle:[function(t,n){n.exports=t("D5DuLP")},{}],G9z0Bl:[function(t,n){function e(){var t=l.info=NREUM.info;if(t&&t.agent&&t.licenseKey&&t.applicationID&&p&&p.body){l.proto="https"===f.split(":")[0]||t.sslForHttp?"https://":"http://",i("mark",["onload",a()]);var n=p.createElement("script");n.src=l.proto+t.agent,p.body.appendChild(n)}}function r(){"complete"===p.readyState&&o()}function o(){i("mark",["domContent",a()])}function a(){return(new Date).getTime()}var i=t("handle"),u=window,p=u.document,s="addEventListener",c="attachEvent",f=(""+location).split("?")[0],l=n.exports={offset:a(),origin:f,features:[]};p[s]?(p[s]("DOMContentLoaded",o,!1),u[s]("load",e,!1)):(p[c]("onreadystatechange",r),u[c]("onload",e)),i("mark",["firstbyte",a()])},{handle:"D5DuLP"}],loader:[function(t,n){n.exports=t("G9z0Bl")},{}]},{},["G9z0Bl"]);</script>
<script src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/1197428788.js" type="text/javascript"></script>

<title>Chapter 9: Updating, showing, and deleting users
 | Ruby on Rails Tutorial | Softcover.io</title>
<meta charset="UTF-8">
<script>
  window.Config = {
    bucket: "softcover"
  }
</script>
<link href="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/reading-0013543a64ea6779764aa99d1540a27e.css" media="screen" rel="stylesheet" type="text/css">
<link href="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/print-ca85c1c74168e935ca4e2e958a3a5c2b.css" media="print" rel="stylesheet" type="text/css">
<script src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/jquery-2.0.3.min.js" type="text/javascript"></script>
<script src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/jquery.formalize.min.js" type="text/javascript"></script>
<script src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/underscore-min.js" type="text/javascript"></script>
<script src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/saved_resource" type="text/javascript"></script>
<script src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/application-ba4cccdb966196cb0931f2e621520564.js" type="text/javascript"></script>
<meta content="authenticity_token" name="csrf-param">
<meta content="sMeti9oCPJDBERMW81INUOkK2TLSj4vOEAtKX4IpDiY=" name="csrf-token">
<link href="http://www.railstutorial.org/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed">
<link href="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/css" rel="stylesheet" type="text/css">
<link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
<script src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/jsapi" type="text/javascript"></script>
<script>
  // test key only
  // this identifies your website in the createToken call below
  Stripe.setPublishableKey('pk_live_Xn1p0BfxqKxkAxtEr03P7wmd');
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('require', 'linker');
  ga('linker:autoLink', ['www.railstutorial.org', 'softcover.io']);

  ga('create', 'UA-46858978-1', 'softcover.io', {'allowLinker': true});
  ga('send', 'pageview');

  ga('create', 'UA-8667566-1', 'auto', {
    'name': 'book',
    'allowLinker': true
  });

  ga('book.send', 'pageview');

</script>
<script type="text/javascript">var _sf_startpt=(new Date()).getTime()</script>


<script src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/custom_domain_js.js" type="text/javascript"></script>
<link type="text/css" rel="stylesheet" href="chrome-extension://cpngackimfmofbokmjmljamhdncknpmg/style.css"><script type="text/javascript" charset="utf-8" src="chrome-extension://cpngackimfmofbokmjmljamhdncknpmg/js/page_context.js"></script><script>window["_GOOG_TRANS_EXT_VER"] = "1";</script><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Hover_Arrow {position: absolute; width: 15px; height: 11px; cursor: pointer}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; color: #666666}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck.RTL {right: .7em; left: auto}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_Menu_Close {position: absolute; width: 31px; height: 31px; top: -15px; left: -15px}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><script>window["_GOOG_TRANS_EXT_VER"] = "1";</script><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Hover_Arrow {position: absolute; width: 15px; height: 11px; cursor: pointer}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; color: #666666}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck.RTL {right: .7em; left: auto}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_Menu_Close {position: absolute; width: 31px; height: 31px; top: -15px; left: -15px}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><script>window["_GOOG_TRANS_EXT_VER"] = "1";</script><script id="mathJaxJS" type="text/javascript" src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/MathJax.js"></script><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Hover_Arrow {position: absolute; width: 15px; height: 11px; cursor: pointer}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; color: #666666}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck.RTL {right: .7em; left: auto}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_Menu_Close {position: absolute; width: 31px; height: 31px; top: -15px; left: -15px}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style></head>
<body screen_capture_injected="true"><div id="MathJax_Message" style="display: none;"></div><div id="MathJax_Message" style="display: none;"></div><div id="MathJax_Message" style="display: none;"></div>
<div class="container closeLeft">
<div class="container_footer">
<div id="header">
<div class="wrapper">
<a href="http://www.railstutorial.org/" class="logo"><img alt="Logo" src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/logo-e741419bc04d21db7e60ddc10883b4f9.png">
</a><a href="javascript://" id="mobileMenu"><div class="closedMenu">
≡
<span>Menu</span>
</div>
<div class="openMenu">
x
<span>Close</span>
</div>
</a><div class="j_userHeader closeLeft" style="display:inline"><ul class="headerMenu">
<li><a href="http://www.softcover.io/login">Log In</a></li>
<li><a href="http://www.softcover.io/account/sign_up">Sign Up</a></li>
</ul>
</div>
<div id="dropBG" style="display: none;"></div>
<div class="clear"></div>
</div>
</div>

<div id="pageBook">
<div id="bookHeader">
<div class="wrapper">
<div class="bookCover">
<a href="http://www.railstutorial.org/book"><img alt="Cover-web" class="cover" src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/cover-web.png">
<img alt="Cover_bg" class="coverBG" src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/cover_bg-88b6816f72bba1e853bbfcd1caff472a.png">
<p>
<i class="ibooksMedia iRead"></i>
READ ONLINE FREE
</p>
</a></div>
<div class="bookInfo">
<h1>
Ruby on Rails Tutorial
<span class="j_subtitle">Learn Rails by Example</span>
<strong>Michael Hartl</strong>
</h1>
<p class="j_description">
 The Ruby on Rails Tutorial book and screencast series teach you how to develop and deploy real, industrial-strength web applications with Ruby on Rails, the open-source web framework that powers top websites such as Twitter, Hulu, GitHub, and the Yellow Pages. The Ruby on Rails Tutorial book is available for free online and is available for purchase as an ebook (PDF, EPUB, and MOBI formats). The companion screencast series includes 15 individual lessons (including a new Rails 4.0 supplement) totaling more than 15 hours, with one lesson for each chapter of the Ruby on Rails Tutorial book. The best value is the ebook/screencast bundle, which includes the 2nd edition book, the Rails 4.0–compatible version, the 2nd edition screencast series, and the Rails 4.0 supplementary screencasts. 
</p>

<div class="bookControls">
<a href="http://www.railstutorial.org/"><button class="transBG">Book Info</button>
</a><a href="mailto:admin@railstutorial.org"><button class="transBG">Contact Author</button>
</a></div>

</div>

</div>
</div>

<div id="bookMenu" class="bookMenuFixed">
<div class="wrapper">
<div class="bookMenuControls">
<div class="bookMenuArows">
<a href="javascript://" class="leftArrow">◄</a>
<a href="javascript://" class="upArrow">▲</a>
<a href="javascript://" class="rightArrow">►</a>
</div>
<div class="bookMenuSize">
<a href="javascript://" class="current" id="sizeRegular"></a>
<a href="javascript://" id="sizeBig"></a>
<a href="javascript://" id="sizeBigger"></a>
</div>
<div class="bookMenuSearch">
<a href="javascript://" id="j_singlePage"><i class="fa fa-search"></i>
Single Page
</a></div>
</div>
<div class="dropDown" id="j_chapterDropDown">
<span id="chapterTitle">Chapter 9: Updating, showing, and deleting users
</span>
<ul class="dropMenu"><li><a>Frontmatter
</a></li><li><a>Chapter 1: From zero to deploy
</a></li><li><a>Chapter 2: A demo app
</a></li><li><a>Chapter 3: Mostly static pages
</a></li><li><a>Chapter 4: Rails-flavored Ruby
</a></li><li><a>Chapter 5: Filling in the layout
</a></li><li><a>Chapter 6: Modeling users
</a></li><li><a>Chapter 7: Sign up
</a></li><li><a>Chapter 8: Sign in, sign out
</a></li><li><a>Chapter 9: Updating, showing, and deleting users
</a></li><li><a>Chapter 10: User microposts
</a></li><li><a>Chapter 11: Following users
</a></li></ul>
</div>
<div class="bookMenuActions j_downloadLinks"><a href="" onclick="$(&#39;#bookMenuEmail&#39;).toggleClass(&#39;open&#39;); return false"><button class="greyButton iEmailUpdate">❤</button>
</a><a href="http://www.railstutorial.org/#pricing" class="buttonStyle attention">Buy Now</a>
<a href="http://www.softcover.io/downloads/28fdb94f/ruby_on_rails_tutorial"><button>Download Previews</button>
</a></div>
</div>
<div class="animated" id="bookMenuEmail">
<div class="wrapper">
<label>Follow this book to receive email updates from the author.</label>
<div class="j_followBookForm"><form accept-charset="UTF-8" action="http://www.softcover.io/follow/28fdb94f/ruby_on_rails_tutorial" method="get"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="✓"></div>
<input name="email" placeholder="YOUR EMAIL ADDRESS" type="text">
<input class="greyButton optClick_follow" type="submit" value="Follow Book">
</form>

</div>
</div>
</div>
</div>
<div class="wrapper" id="bookWr">
<div class="bookChapterTop">Chapter 9: Updating, showing, and deleting users
</div>
<div id="bookHtml" style="opacity: 1;"><div id="book"><div id="_cha-updating_showing_and_deleting_users" data-tralics-id="cid52" class="chapter" data-number="9" data-chapter="updating_and_deleting_users"><h1><a href="http://www.railstutorial.org/book/updating_and_deleting_users#cha-updating_showing_and_deleting_users" class="heading hyperref"><span class="number">Chapter 9 </span>Updating, showing, and deleting users</a></h1>
<p>In this chapter, we will complete the REST actions for the Users resource (<a href="http://www.railstutorial.org/book/sign_up#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a>) by adding <code>edit</code>, <code>update</code>, <code>index</code>, and <code>destroy</code> actions.<span class="intersentencespace"></span> We’ll start by giving users the ability to update their profiles, which will also provide a natural opportunity to enforce a security model (made possible by the authorization code in <a href="http://www.railstutorial.org/book/sign_in_out#cha-sign_in_sign_out" class="hyperref">Chapter&nbsp;<span class="ref">8</span></a>).<span class="intersentencespace"></span> Then we’ll make a listing of all users (also requiring authorization), which will motivate the introduction of sample data and pagination.<span class="intersentencespace"></span> Finally, we’ll add the ability to destroy users, wiping them clear from the database.<span class="intersentencespace"></span> Since we can’t allow just any user to have such dangerous powers, we’ll take care to create a privileged class of administrative users (admins) authorized to delete other users.</p>
<p>To get started, let’s start work on an <code>updating-users</code> topic branch:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b updating-users
</pre></div></div>
</div><div id="_sec-updating_users" data-tralics-id="cid53" class="section" data-number="9.1"><h2><a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-updating_users" class="heading hyperref"><span class="number">9.1 </span>Updating users</a></h2>
<p>The pattern for editing user information closely parallels that for creating new users (<a href="http://www.railstutorial.org/book/sign_up#cha-sign_up" class="hyperref">Chapter&nbsp;<span class="ref">7</span></a>).<span class="intersentencespace"></span> Instead of a <code>new</code> action rendering a view for new users, we have an <code>edit</code> action rendering a view to edit users; instead of <code>create</code> responding to a <span class="tt">POST</span> request, we have an <code>update</code> action responding to a <span class="tt">PATCH</span> request (<a href="http://www.railstutorial.org/book/static_pages#sidebar-get_etc" class="hyperref">Box&nbsp;<span class="ref">3.3</span></a>).<span class="intersentencespace"></span> The biggest difference is that, while anyone can sign up, only the current user should be able to update their information.<span class="intersentencespace"></span> This means that we need to enforce access control so that only authorized users can edit and update; the authentication machinery from <a href="http://www.railstutorial.org/book/sign_in_out#cha-sign_in_sign_out" class="hyperref">Chapter&nbsp;<span class="ref">8</span></a> will allow us to use a <em>before filter</em> to ensure that this is the case.</p>
<div id="_sec-edit_form" data-tralics-id="uid671" class="subsection" data-number="9.1.1"><h3><a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-edit_form" class="heading hyperref"><span class="number">9.1.1 </span>Edit form</a></h3>
<p>We start with the edit form, whose mockup appears in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#fig-edit_user_mockup" class="hyperref">Figure&nbsp;<span class="ref">9.1</span></a>.<sup id="_cha-9_footnote-ref-1" class="footnote intersentence"><a href="http://www.railstutorial.org/book/updating_and_deleting_users#cha-9_footnote-1">1</a></sup><span class="intersentencespace"></span> As usual, we’ll begin with some tests.<span class="intersentencespace"></span> First, note the link to change the Gravatar image; if you poke around the Gravatar site, you’ll see that the page to add or edit images is located at <a href="http://gravatar.com/emails">http://gravatar.com/emails</a>, so we test the <code>edit</code> page for a link with that URL.<sup id="_cha-9_footnote-ref-2" class="footnote"><a href="http://www.railstutorial.org/book/updating_and_deleting_users#cha-9_footnote-2">2</a></sup></p>
<div class="center figure" id="_fig-edit_user_mockup" data-tralics-id="uid674" data-number="9.1">
<div class="graphics image box"><img src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/edit_user_mockup_bootstrap.png" alt="images/figures/edit_user_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 9.1: </span><span class="description">A mockup of the user edit page.
</span></div></div>
<p>The tests for the edit user form are analogous to the test for the new user form in <a href="http://www.railstutorial.org/book/sign_up#code-error_messages_test" class="hyperref">Listing&nbsp;<span class="ref">7.31</span></a> from the <a href="http://www.railstutorial.org/book/sign_up#cha-sign_up" class="hyperref">Chapter&nbsp;<span class="ref">7</span></a> exercises, which added a test for the error message on invalid submission.<span class="intersentencespace"></span> The result appears in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-user_edit_specs" class="hyperref">Listing&nbsp;<span class="ref">9.1</span></a>.</p>
<div class="codelisting" id="_code-user_edit_specs" data-tralics-id="uid675" data-number="9.1"><div class="heading"><span class="number">Listing 9.1:</span> 

<span class="description">Tests for the user edit page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/user_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"edit"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"page"</span> <span class="k">do</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s2">"Update your profile"</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s2">"Edit user"</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="s1">'http://gravatar.com/emails'</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">"with invalid information"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Save changes"</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'error'</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>To write the application code, we need to fill in the <code>edit</code> action in the Users controller.<span class="intersentencespace"></span> Note from <a href="http://www.railstutorial.org/book/sign_up#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a> that the proper URL for a user’s edit page is /users/1/edit (assuming the user’s id is&nbsp;<span class="tt">1</span>).<span class="intersentencespace"></span> Recall that the id of the user is available in the <code>params[:id]</code> variable, which means that we can find the user with the code in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-initial_edit_action" class="hyperref">Listing&nbsp;<span class="ref">9.2</span></a>.</p>
<div class="codelisting" id="_code-initial_edit_action" data-tralics-id="uid676" data-number="9.2"><div class="heading"><span class="number">Listing 9.2:</span> 

<span class="description">The user <code>edit</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Getting the tests to pass requires making the actual edit view, shown in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-user_edit_view" class="hyperref">Listing&nbsp;<span class="ref">9.3</span></a>.<span class="intersentencespace"></span> Note how closely this resembles the new user view from <a href="http://www.railstutorial.org/book/sign_up#code-signup_form" class="hyperref">Listing&nbsp;<span class="ref">7.17</span></a>; the large overlap suggests factoring the repeated code into a partial, which is left as an exercise (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-updating_deleting_exercises" class="hyperref">Section&nbsp;<span class="ref">9.6</span></a>).</p>
<div class="codelisting" id="_code-user_edit_view" data-tralics-id="uid677" data-number="9.3"><div class="heading"><span class="number">Listing 9.3:</span> 

<span class="description">The user edit view.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/edit.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Edit user"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Update your profile<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span6 offset3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">"Confirm Password"</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Save changes"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-large btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://gravatar.com/emails"</span><span class="nt">&gt;</span>change<span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><p>Here we have reused the shared <code>error_messages</code> partial introduced in <a href="http://www.railstutorial.org/book/sign_up#sec-signup_error_messages" class="hyperref">Section&nbsp;<span class="ref">7.3.3</span></a>.</p>
<p>With the <code>@user</code> instance variable from <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-initial_edit_action" class="hyperref">Listing&nbsp;<span class="ref">9.2</span></a>, the edit page tests from <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-user_edit_specs" class="hyperref">Listing&nbsp;<span class="ref">9.1</span></a> should pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb -e <span class="s2">"edit page"</span>
</pre></div></div>
<p>The corresponding page appears in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#fig-edit_page" class="hyperref">Figure&nbsp;<span class="ref">9.2</span></a>, which shows how Rails automatically pre-fills the Name and Email fields using the attributes of the <code>@user</code> variable.</p>
<div class="center figure" id="_fig-edit_page" data-tralics-id="uid678" data-number="9.2">
<div class="graphics image box"><img src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/edit_page_bootstrap.png" alt="images/figures/edit_page_bootstrap"></div><div class="caption"><span class="header">Figure 9.2: </span><span class="description">The initial user edit page with pre-filled name &amp; email.
</span></div></div>
<p>Looking at the HTML source for <a href="http://www.railstutorial.org/book/updating_and_deleting_users#fig-edit_page" class="hyperref">Figure&nbsp;<span class="ref">9.2</span></a>, we see a form tag as expected (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-edit_form_html" class="hyperref">Listing&nbsp;<span class="ref">9.4</span></a>).</p>
<div class="codelisting" id="_code-edit_form_html" data-tralics-id="uid679" data-number="9.4"><div class="heading"><span class="number">Listing 9.4:</span> 

<span class="description">HTML for the edit form defined in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-user_edit_view" class="hyperref">Listing&nbsp;<span class="ref">9.3</span></a> and shown in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#fig-edit_page" class="hyperref">Figure&nbsp;<span class="ref">9.2</span></a>.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/users/1"</span> <span class="na">class=</span><span class="s">"edit_user"</span> <span class="na">id=</span><span class="s">"edit_user_1"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"_method"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"patch"</span> <span class="nt">/&gt;</span>
  .
  .
  .
<span class="nt">&lt;/form&gt;</span>
</pre></div></div></div><p>Note here the hidden input field</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"_method"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"patch"</span> <span class="nt">/&gt;</span>
</pre></div></div>
<p>Since web browsers can’t natively send <span class="tt">PATCH</span> requests (as required by the REST conventions from <a href="http://www.railstutorial.org/book/sign_up#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a>), Rails fakes it with a <span class="tt">POST</span> request and a hidden <code>input</code> field.<sup id="_cha-9_footnote-ref-3" class="footnote"><a href="http://www.railstutorial.org/book/updating_and_deleting_users#cha-9_footnote-3">3</a></sup></p>
<p>There’s another subtlety to address here: the code <code>form_for(@user)</code> in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-user_edit_view" class="hyperref">Listing&nbsp;<span class="ref">9.3</span></a> is <em>exactly</em> the same as the code in <a href="http://www.railstutorial.org/book/sign_up#code-signup_form" class="hyperref">Listing&nbsp;<span class="ref">7.17</span></a>—so how does Rails know to use a <span class="tt">POST</span> request for new users and a <span class="tt">PATCH</span> for editing users?<span class="intersentencespace"></span> The answer is that it is possible to tell whether a user is new or already exists in the database via Active Record’s <code>new_record?</code> boolean method:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">new_record?</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">new_record?</span>
<span class="go">=&gt; false</span>
</pre></div></div>
<p>When constructing a form using <code>form_for(@user)</code>, Rails uses <span class="tt">POST</span> if <code>@user.new_record?</code> is <code>true</code> and <span class="tt">PATCH</span> if it is <code>false</code>.</p>
<p>As a final touch, we’ll add a URL to the user settings link to the site navigation.<span class="intersentencespace"></span> Since it depends on the signin status of the user, the test for the “Settings” link belongs with the other authentication tests, as shown in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-settings_link_test" class="hyperref">Listing&nbsp;<span class="ref">9.5</span></a>.<span class="intersentencespace"></span> (It would be nice to have additional tests verifying that such links <em>don’t</em> appear for users who aren’t signed in; writing these tests is left as an exercise (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-updating_deleting_exercises" class="hyperref">Section&nbsp;<span class="ref">9.6</span></a>).)</p>
<div class="codelisting" id="_code-settings_link_test" data-tralics-id="uid681" data-number="9.5"><div class="heading"><span class="number">Listing 9.5:</span> 

<span class="description">Adding a test for the “Settings” link.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Profile'</span><span class="p">,</span>     <span class="ss">href</span><span class="p">:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Settings'</span><span class="p">,</span>    <span class="ss">href</span><span class="p">:</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign out'</span><span class="p">,</span>    <span class="ss">href</span><span class="p">:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>For convenience, the code in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-settings_link_test" class="hyperref">Listing&nbsp;<span class="ref">9.5</span></a> uses a helper to sign in a user inside the tests.<span class="intersentencespace"></span> The method is to visit the signin page and submit valid information, as shown in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-sign_in_helper" class="hyperref">Listing&nbsp;<span class="ref">9.6</span></a>.</p>
<div class="codelisting" id="_code-sign_in_helper" data-tralics-id="uid682" data-number="9.6"><div class="heading"><span class="number">Listing 9.6:</span> 

<span class="description">A test helper to sign users in.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/support/utilities.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{})</span>
  <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:no_capybara</span><span class="o">]</span>
    <span class="c1"># Sign in when not using Capybara.</span>
    <span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_remember_token</span>
    <span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">remember_token</span>
    <span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">remember_token</span><span class="p">))</span>
  <span class="k">else</span>
    <span class="n">visit</span> <span class="n">signin_path</span>
    <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>    <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
    <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
    <span class="n">click_button</span> <span class="s2">"Sign in"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>As noted in the comment line, filling in the form doesn’t work when not using Capybara, so to cover this case we allow the user to pass the option <code>no_capybara: true</code> to override the default signin method and manipulate the cookies directly.<span class="intersentencespace"></span> This is necessary when using one of the HTTP request methods directly (<code>get</code>, <code>post</code>, <code>patch</code>, or <code>delete</code>), as we’ll see in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-delete_destroy_test" class="hyperref">Listing&nbsp;<span class="ref">9.45</span></a>.<span class="intersentencespace"></span> (Note that the test <code>cookies</code> object isn’t a perfect simulation of the real cookies object; in particular, the <code>cookies.permanent</code> method seen in <a href="http://www.railstutorial.org/book/sign_in_out#code-sign_in_function" class="hyperref">Listing&nbsp;<span class="ref">8.19</span></a> doesn’t work inside tests.)<span class="intersentencespace"></span> As you might suspect, the <code>sign_in</code> method will prove useful in future tests, and in fact it can already be used to eliminate some duplication (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-updating_deleting_exercises" class="hyperref">Section&nbsp;<span class="ref">9.6</span></a>).</p>
<p>The application code to add the URL for the “Settings” link is simple: we just use the named route <code>edit_user_path</code> from <a href="http://www.railstutorial.org/book/sign_up#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a>, together with the handy <code>current_user</code> helper method defined in <a href="http://www.railstutorial.org/book/sign_in_out#code-current_user_working" class="hyperref">Listing&nbsp;<span class="ref">8.22</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>The full application code appears in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-settings_link" class="hyperref">Listing&nbsp;<span class="ref">9.7</span></a>).</p>
<div class="codelisting" id="_code-settings_link" data-tralics-id="uid683" data-number="9.7"><div class="heading"><span class="number">Listing 9.7:</span> 

<span class="description">Adding a “Settings” link.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/layouts/_header.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"navbar navbar-fixed-top navbar-inverse"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-inner"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"sample app"</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">"logo"</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav pull-right"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Home"</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Help"</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Users"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">"fat-menu"</span> <span class="na">class=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"dropdown-toggle"</span> <span class="na">data-toggle=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
                Account <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">"caret"</span><span class="nt">&gt;&lt;/b&gt;</span>
              <span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"dropdown-menu"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"divider"</span><span class="nt">&gt;&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign out"</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">"delete"</span> <span class="cp">%&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign in"</span><span class="p">,</span> <span class="n">signin_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div></div></div></div>
<div id="_sec-unsuccessful_edits" data-tralics-id="uid684" class="subsection" data-number="9.1.2"><h3><a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-unsuccessful_edits" class="heading hyperref"><span class="number">9.1.2 </span>Unsuccessful edits</a></h3>
<p>In this section we’ll handle unsuccessful edits and get the error messages test in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-user_edit_specs" class="hyperref">Listing&nbsp;<span class="ref">9.1</span></a> to pass.<span class="intersentencespace"></span> The application code creates an <code>update</code> action that uses <code>update_attributes</code> (<a href="http://www.railstutorial.org/book/modeling_users#sec-updating_user_objects" class="hyperref">Section&nbsp;<span class="ref">6.1.5</span></a>) to update the user based on the submitted <code>params</code> hash, as shown in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-user_update_action_unsuccessful" class="hyperref">Listing&nbsp;<span class="ref">9.8</span></a>.<span class="intersentencespace"></span> With invalid information, the update attempt returns <code>false</code>, so the <code>else</code> branch re-renders the edit page.<span class="intersentencespace"></span> We’ve seen this pattern before; the structure closely parallels the first version of the <code>create</code> action (<a href="http://www.railstutorial.org/book/sign_up#code-first_create_action" class="hyperref">Listing&nbsp;<span class="ref">7.21</span></a>).</p>
<div class="codelisting" id="_code-user_update_action_unsuccessful" data-tralics-id="uid685" data-number="9.8"><div class="heading"><span class="number">Listing 9.8:</span> 

<span class="description">The initial user <code>update</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
      <span class="c1"># Handle a successful update.</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'edit'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Note the use of <code>user_params</code> in the call to <code>update_attributes</code>, which uses strong parameters to prevent mass assignment vulnerability (as described in <a href="http://www.railstutorial.org/book/sign_up#sec-strong_parameters" class="hyperref">Section&nbsp;<span class="ref">7.3.2</span></a>).</p>
<p>The resulting error message (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#fig-edit_with_invalid_information" class="hyperref">Figure&nbsp;<span class="ref">9.3</span></a>) is the one needed to get the error message test to pass, as you should verify by running the test suite:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
<div class="center figure" id="_fig-edit_with_invalid_information" data-tralics-id="uid686" data-number="9.3">
<div class="graphics image box"><img src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/edit_with_invalid_information_bootstrap.png" alt="images/figures/edit_with_invalid_information_bootstrap"></div><div class="caption"><span class="header">Figure 9.3: </span><span class="description">Error message from submitting the update form.
</span></div></div>
</div>
<div id="_sec-successful_edits" data-tralics-id="uid687" class="subsection" data-number="9.1.3"><h3><a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-successful_edits" class="heading hyperref"><span class="number">9.1.3 </span>Successful edits</a></h3>
<p>Now it’s time to get the edit form to work.<span class="intersentencespace"></span> Editing the profile images is already functional since we’ve outsourced image upload to Gravatar; we can edit gravatars by clicking on the “change” link from <a href="http://www.railstutorial.org/book/updating_and_deleting_users#fig-edit_page" class="hyperref">Figure&nbsp;<span class="ref">9.2</span></a>, as shown in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#fig-gravatar_cropper" class="hyperref">Figure&nbsp;<span class="ref">9.4</span></a>.<span class="intersentencespace"></span> Let’s get the rest of the user edit functionality working as well.</p>
<div class="center figure" id="_fig-gravatar_cropper" data-tralics-id="uid688" data-number="9.4">
<div class="graphics image box"><img src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/gravatar_cropper.png" alt="images/figures/gravatar_cropper"></div><div class="caption"><span class="header">Figure 9.4: </span><span class="description">The <a href="http://gravatar.com/">Gravatar</a> image-cropping interface, with a picture of <a href="http://michaelhartl.com/">some dude</a>.
</span></div></div>
<p>The tests for the <code>update</code> action are similar to those for <code>create</code>.<span class="intersentencespace"></span> <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-user_update_specs" class="hyperref">Listing&nbsp;<span class="ref">9.9</span></a> shows how to use Capybara to fill in the form fields with valid information and then test that the resulting behavior is correct.<span class="intersentencespace"></span> This is a lot of code; see if you can work through it by referring back to the tests in <a href="http://www.railstutorial.org/book/sign_up#cha-sign_up" class="hyperref">Chapter&nbsp;<span class="ref">7</span></a>.</p>
<div class="codelisting" id="_code-user_update_specs" data-tralics-id="uid689" data-number="9.9"><div class="heading"><span class="number">Listing 9.9:</span> 

<span class="description">Tests for the user <code>update</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/user_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"edit"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:new_name</span><span class="p">)</span>  <span class="p">{</span> <span class="s2">"New Name"</span> <span class="p">}</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:new_email</span><span class="p">)</span> <span class="p">{</span> <span class="s2">"new@example.com"</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">fill_in</span> <span class="s2">"Name"</span><span class="p">,</span>             <span class="ss">with</span><span class="p">:</span> <span class="n">new_name</span>
        <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>            <span class="ss">with</span><span class="p">:</span> <span class="n">new_email</span>
        <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span>         <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
        <span class="n">fill_in</span> <span class="s2">"Confirm Password"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
        <span class="n">click_button</span> <span class="s2">"Save changes"</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-success'</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign out'</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">to</span>  <span class="n">eq</span> <span class="n">new_name</span> <span class="p">}</span>
      <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="n">new_email</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-user_update_specs" class="hyperref">Listing&nbsp;<span class="ref">9.9</span></a> adds the <code>sign_in</code> method from <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-sign_in_helper" class="hyperref">Listing&nbsp;<span class="ref">9.6</span></a> to the <code>before</code> block, which is required for the “Sign out” link test to pass, and also anticipates protecting the <code>edit</code> action from non-signed-in users (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-requiring_signed_in_users" class="hyperref">Section&nbsp;<span class="ref">9.2.1</span></a>).</p>
<p>The only real novelty in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-user_update_specs" class="hyperref">Listing&nbsp;<span class="ref">9.9</span></a> is the <code>reload</code> method, which appears in the test for changing the user’s attributes:</p>
<div class="code"><div class="highlight"><pre><span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">to</span>  <span class="n">eq</span> <span class="n">new_name</span> <span class="p">}</span>
<span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="n">new_email</span> <span class="p">}</span>
</pre></div></div>
<p>This reloads the <code>user</code> variable from the test database using <code>user.reload</code>, and then verifies that the user’s new name and email match the new values.</p>
<p>The <code>update</code> action needed to get the tests in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-user_update_specs" class="hyperref">Listing&nbsp;<span class="ref">9.9</span></a> to pass is similar to the final form of the <code>create</code> action (<a href="http://www.railstutorial.org/book/sign_in_out#code-signin_upon_signup" class="hyperref">Listing&nbsp;<span class="ref">8.27</span></a>), as seen in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-user_update_action" class="hyperref">Listing&nbsp;<span class="ref">9.10</span></a>.<span class="intersentencespace"></span> All this does is add</p>
<div class="code"><div class="highlight"><pre><span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Profile updated"</span>
<span class="n">redirect_to</span> <span class="vi">@user</span>
</pre></div></div>
<p>to the code in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-user_update_action_unsuccessful" class="hyperref">Listing&nbsp;<span class="ref">9.8</span></a>.</p>
<div class="codelisting" id="_code-user_update_action" data-tralics-id="uid690" data-number="9.10"><div class="heading"><span class="number">Listing 9.10:</span> 

<span class="description">The user <code>update</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Profile updated"</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'edit'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that, as currently constructed, every edit requires the user to reconfirm the password (as implied by the empty confirmation text box in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#fig-edit_page" class="hyperref">Figure&nbsp;<span class="ref">9.2</span></a>), which is a minor annoyance but is easier to code and decreases the likelihood of submitting a password with a typo.</p>
<p>With the code in this section, the user edit page should be working, as you can double-check by re-running the test suite, which should now be green:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div></div><div id="_sec-authorization" data-tralics-id="cid54" class="section" data-number="9.2"><h2><a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-authorization" class="heading hyperref"><span class="number">9.2 </span>Authorization</a></h2>
<p>One nice effect of building the authentication machinery in <a href="http://www.railstutorial.org/book/sign_in_out#cha-sign_in_sign_out" class="hyperref">Chapter&nbsp;<span class="ref">8</span></a> is that we are now in a position to implement authorization as well: <em>authentication</em> allows us to identify users of our site, and <em>authorization</em> lets us control what they can do.</p>
<p>Although the edit and update actions from <a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-updating_users" class="hyperref">Section&nbsp;<span class="ref">9.1</span></a> are functionally complete, they suffer from a ridiculous security flaw: they allow anyone (even non-signed-in users) to access either action, and any signed-in user can update the information for any other user.<span class="intersentencespace"></span> In this section, we’ll implement a security model that requires users to be signed in and prevents them from updating any information other than their own.<span class="intersentencespace"></span> Users who aren’t signed in and who try to access protected pages will be forwarded to the signin page with a helpful message, as mocked up in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#fig-signin_page_protected_mockup" class="hyperref">Figure&nbsp;<span class="ref">9.5</span></a>.</p>
<div class="center figure" id="_fig-signin_page_protected_mockup" data-tralics-id="uid691" data-number="9.5">
<div class="graphics image box"><img src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/signin_page_protected_mockup_bootstrap.png" alt="images/figures/signin_page_protected_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 9.5: </span><span class="description">A mockup of the result of visiting a protected page
</span></div></div>
<div id="_sec-requiring_signed_in_users" data-tralics-id="uid692" class="subsection" data-number="9.2.1"><h3><a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-requiring_signed_in_users" class="heading hyperref"><span class="number">9.2.1 </span>Requiring signed-in users</a></h3>
<p>Since the security restrictions for the <code>edit</code> and <code>update</code> actions are identical, we’ll handle them in a single RSpec <code>describe</code> block.<span class="intersentencespace"></span> Starting with the sign-in requirement, our initial tests verify that non-signed-in users attempting to access either action are simply sent to the signin page, as seen in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-protected_edit_update_tests" class="hyperref">Listing&nbsp;<span class="ref">9.11</span></a>.</p>
<div class="codelisting" id="_code-protected_edit_update_tests" data-tralics-id="uid693" data-number="9.11"><div class="heading"><span class="number">Listing 9.11:</span> 

<span class="description">Testing that the <code>edit</code> and <code>update</code> actions are protected.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"authorization"</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">"for non-signed-in users"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">"in the Users controller"</span> <span class="k">do</span>

        <span class="n">describe</span> <span class="s2">"visiting the edit page"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">"submitting to the update action"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">patch</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The code in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-protected_edit_update_tests" class="hyperref">Listing&nbsp;<span class="ref">9.11</span></a> introduces a second way, apart from Capybara’s <code>visit</code> method, to access a controller action: by issuing the appropriate HTTP request directly, in this case using the <code>patch</code> method to issue a <span class="tt">PATCH</span> request:</p>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">"submitting to the update action"</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">patch</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div>
<p>This issues a <span class="tt">PATCH</span> request directly to <code>/users/1</code>, which gets routed to the <code>update</code> action of the Users controller (<a href="http://www.railstutorial.org/book/sign_up#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a>).<span class="intersentencespace"></span> This is necessary because there is no way for a browser to visit the <code>update</code> action directly—it can only get there indirectly by submitting the edit form—so Capybara can’t do it either.<span class="intersentencespace"></span> But visiting the edit page only tests the authorization for the <code>edit</code> action, not for <code>update</code>.<span class="intersentencespace"></span> As a result, the only way to test the proper authorization for the <code>update</code> action itself is to issue a direct request.<span class="intersentencespace"></span> (As you might guess, in addition to <code>patch</code> Rails tests support <code>get</code>, <code>post</code>, and <code>delete</code> as well.)</p>
<p>When using one of the methods to issue HTTP requests directly, we get access to the low-level <code>response</code> object.<span class="intersentencespace"></span> Unlike the Capybara <code>page</code> object, <code>response</code> lets us test for the server response itself, in this case verifying that the <code>update</code> action responds by redirecting to the signin page:</p>
<div class="code"><div class="highlight"><pre><span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
</pre></div></div>
<p>The authorization application code uses a <em>before filter</em>, which uses the <code>before_action</code> command to arrange for a particular method to be called before the given actions.<span class="intersentencespace"></span> (The command for before filters used to be called <code>before_filter</code>, but the Rails core team decided to rename it to emphasize that the filter takes place before particular controller actions.)<span class="intersentencespace"></span> To require users to be signed in, we define a <code>signed_in_user</code> method and invoke it using <code>before_action :signed_in_user</code>, as shown in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-authorize_before_filter" class="hyperref">Listing&nbsp;<span class="ref">9.12</span></a>.</p>
<div class="codelisting" id="_code-authorize_before_filter" data-tralics-id="uid694" data-number="9.12"><div class="heading"><span class="number">Listing 9.12:</span> 

<span class="description">Adding a <code>signed_in_user</code> before filter.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># Before filters</span>

    <span class="k">def</span> <span class="nf">signed_in_user</span>
      <span class="n">redirect_to</span> <span class="n">signin_url</span><span class="p">,</span> <span class="ss">notice</span><span class="p">:</span> <span class="s2">"Please sign in."</span> <span class="k">unless</span> <span class="n">signed_in?</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>By default, before filters apply to <em>every</em> action in a controller, so here we restrict the filter to act only on the <code>:edit</code> and <code>:update</code> actions by passing the appropriate <code>:only</code> options hash.</p>
<p>Note that <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-authorize_before_filter" class="hyperref">Listing&nbsp;<span class="ref">9.12</span></a> uses a shortcut for setting <code>flash[:notice]</code> by passing an options hash to the <code>redirect_to</code> function.<span class="intersentencespace"></span> The code in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-authorize_before_filter" class="hyperref">Listing&nbsp;<span class="ref">9.12</span></a> is equivalent to the more verbose</p>
<div class="code"><div class="highlight"><pre><span class="k">unless</span> <span class="n">signed_in?</span>
  <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Please sign in."</span>
  <span class="n">redirect_to</span> <span class="n">signin_url</span>
<span class="k">end</span>
</pre></div></div>
<p>(Unfortunately, the same construction doesn’t work for the <code>:error</code> or <code>:success</code> keys.)</p>
<p>Together with <code>:success</code> and <code>:error</code>, the <code>:notice</code> key completes our triumvirate of <code>flash</code> styles, all of which are supported natively by Bootstrap CSS. By signing out and attempting to access the user edit page <a href="http://localhost:3000/users/1/edit">/users/1/edit</a>, we can see the resulting yellow “notice” box, as seen in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#fig-protected_sign_in" class="hyperref">Figure&nbsp;<span class="ref">9.6</span></a>.</p>
<div class="center figure" id="_fig-protected_sign_in" data-tralics-id="uid695" data-number="9.6">
<div class="graphics image box"><img src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/protected_sign_in_bootstrap.png" alt="images/figures/protected_sign_in_bootstrap"></div><div class="caption"><span class="header">Figure 9.6: </span><span class="description">The signin form after trying to access a protected page.
</span></div></div>
<p>At this point, our test suite should be green:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div>
<div id="_sec-requiring_the_right_user" data-tralics-id="uid696" class="subsection" data-number="9.2.2"><h3><a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-requiring_the_right_user" class="heading hyperref"><span class="number">9.2.2 </span>Requiring the right user</a></h3>
<p>Of course, requiring users to sign in isn’t quite enough; users should only be allowed to edit their <em>own</em> information.<span class="intersentencespace"></span> We can test for this by first signing in as an incorrect user and then hitting the <code>edit</code> and <code>update</code> actions (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-edit_update_wrong_user_tests" class="hyperref">Listing&nbsp;<span class="ref">9.13</span></a>).<span class="intersentencespace"></span> Note that, because we’re not using Capybara for these tests (<code>no_capybara: true</code>), we use the <code>get</code> and <code>patch</code> methods to hit the <code>edit</code> and <code>update</code> actions directly.<span class="intersentencespace"></span> In addition, because users should never even <em>try</em> to edit another user’s profile, upon detecting unauthorized access we redirect to the root URL rather than to the signin page.</p>
<div class="codelisting" id="_code-edit_update_wrong_user_tests" data-tralics-id="uid697" data-number="9.13"><div class="heading"><span class="number">Listing 9.13:</span> 

<span class="description">Testing that the <code>edit</code> and <code>update</code> actions require the right user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"authorization"</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"as wrong user"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:wrong_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"wrong@example.com"</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span><span class="p">,</span> <span class="n">no_capybara</span><span class="p">:</span> <span class="kp">true</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">"submitting a GET request to the Users#edit action"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">get</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">wrong_user</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">match</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">'Edit user'</span><span class="p">))</span> <span class="p">}</span>
        <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_url</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">"submitting a PATCH request to the Users#update action"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">patch</span> <span class="n">user_path</span><span class="p">(</span><span class="n">wrong_user</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_url</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note here that a factory can take an option:</p>
<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"wrong@example.com"</span><span class="p">)</span>
</pre></div></div>
<p>This creates a user with a different email address from the default.<span class="intersentencespace"></span> The tests specify that the original user should not have access to the wrong user’s <code>edit</code> or <code>update</code> actions.</p>
<p>The application code adds a second before filter to call the <code>correct_user</code> method, as shown in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-correct_user_before_filter" class="hyperref">Listing&nbsp;<span class="ref">9.14</span></a>.</p>
<div class="codelisting" id="_code-correct_user_before_filter" data-tralics-id="uid698" data-number="9.14"><div class="heading"><span class="number">Listing 9.14:</span> 

<span class="description">A <code>correct_user</code> before filter to protect the edit/update pages.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Profile updated"</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'edit'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># Before filters</span>

    <span class="k">def</span> <span class="nf">signed_in_user</span>
      <span class="n">redirect_to</span> <span class="n">signin_url</span><span class="p">,</span> <span class="ss">notice</span><span class="p">:</span> <span class="s2">"Please sign in."</span> <span class="k">unless</span> <span class="n">signed_in?</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_url</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The <code>correct_user</code> filter uses the <code>current_user?</code> boolean method, which we define in the Sessions helper (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-current_user_p" class="hyperref">Listing&nbsp;<span class="ref">9.15</span></a>).</p>
<div class="codelisting" id="_code-current_user_p" data-tralics-id="uid699" data-number="9.15"><div class="heading"><span class="number">Listing 9.15:</span> 

<span class="description">The <code>current_user?</code> method.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="n">remember_token</span><span class="p">:</span> <span class="n">remember_token</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">==</span> <span class="n">current_user</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p><a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-correct_user_before_filter" class="hyperref">Listing&nbsp;<span class="ref">9.14</span></a> also shows the updated <code>edit</code> and <code>update</code> actions.<span class="intersentencespace"></span> Before, in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-initial_edit_action" class="hyperref">Listing&nbsp;<span class="ref">9.2</span></a>, we had</p>
<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">edit</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p>and similarly for <code>update</code>.<span class="intersentencespace"></span> Now that the <code>correct_user</code> before filter defines <code>@user</code>, we can omit it from both actions.</p>
<p>Before moving on, you should verify that the test suite passes:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div>
<div id="_sec-friendly_forwarding" data-tralics-id="uid700" class="subsection" data-number="9.2.3"><h3><a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-friendly_forwarding" class="heading hyperref"><span class="number">9.2.3 </span>Friendly forwarding</a></h3>
<p>Our site authorization is complete as written, but there is one minor blemish: when users try to access a protected page, they are currently redirected to their profile pages regardless of where they were trying to go.<span class="intersentencespace"></span> In other words, if a non-logged-in user tries to visit the edit page, after signing in the user will be redirected to /users/1 instead of /users/1/edit.<span class="intersentencespace"></span> It would be much friendlier to redirect them to their intended destination instead.</p>
<p>To test for such “friendly forwarding”, we first visit the user edit page, which redirects to the signin page.<span class="intersentencespace"></span> We then enter valid signin information and click the “Sign in” button.<span class="intersentencespace"></span> The resulting page, which by default is the user’s profile, should in this case be the “Edit user” page.<span class="intersentencespace"></span> The test for this sequence appears in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-friendly_forwarding_test" class="hyperref">Listing&nbsp;<span class="ref">9.16</span></a>.</p>
<div class="codelisting" id="_code-friendly_forwarding_test" data-tralics-id="uid701" data-number="9.16"><div class="heading"><span class="number">Listing 9.16:</span> 

<span class="description">A test for friendly forwarding.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"authorization"</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">"for non-signed-in users"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">"when attempting to visit a protected page"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
          <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>    <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
          <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
          <span class="n">click_button</span> <span class="s2">"Sign in"</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">"after signing in"</span> <span class="k">do</span>

          <span class="n">it</span> <span class="s2">"should render the desired protected page"</span> <span class="k">do</span>
            <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'Edit user'</span><span class="p">)</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Now for the implementation.<sup id="_cha-9_footnote-ref-4" class="footnote intersentence"><a href="http://www.railstutorial.org/book/updating_and_deleting_users#cha-9_footnote-4">4</a></sup><span class="intersentencespace"></span> In order to forward users to their intended destination, we need to store the location of the requested page somewhere, and then redirect to that location instead.<span class="intersentencespace"></span> We accomplish this with a pair of methods, <code>store_location</code> and <code>redirect_back_or</code>, both defined in the Sessions helper (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-friendly_forwarding_code" class="hyperref">Listing&nbsp;<span class="ref">9.17</span></a>).</p>
<div class="codelisting" id="_code-friendly_forwarding_code" data-tralics-id="uid703" data-number="9.17"><div class="heading"><span class="number">Listing 9.17:</span> 

<span class="description">Code to implement friendly forwarding.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">redirect_back_or</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
    <span class="n">redirect_to</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:return_to</span><span class="o">]</span> <span class="o">||</span> <span class="n">default</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:return_to</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">store_location</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:return_to</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">get?</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The storage mechanism is the <code>session</code> facility provided by Rails, which you can think of as being like an instance of the <code>cookies</code> variable from <a href="http://www.railstutorial.org/book/sign_in_out#sec-remember_me" class="hyperref">Section&nbsp;<span class="ref">8.2.1</span></a> that automatically expires upon browser close.<span class="intersentencespace"></span> We also use the <code>request</code> object to get the <code>url</code>, i.e., the URL of the requested page.<span class="intersentencespace"></span> The <code>store_location</code> method puts the requested URL in the <code>session</code> variable under the key <code>:return_to</code>, but only for a <code>GET</code> request (<code>if request.get?</code>).<span class="intersentencespace"></span> This prevents storing the forwarding URL if a user, say, submits a form when not logged in (which is an edge case but could happen if, e.g., a user deleted the remember token by hand before submitting the form); in this case, the resulting redirect would issue a <code>GET</code> request to a URL expecting <code>POST</code>, <code>PATCH</code>, or <code>DELETE</code>, thereby causing an error.<sup id="_cha-9_footnote-ref-5" class="footnote"><a href="http://www.railstutorial.org/book/updating_and_deleting_users#cha-9_footnote-5">5</a></sup></p>
<p>To make use of <code>store_location</code>, we need to add it to the <code>signed_in_user</code> before filter, as shown in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-add_store_location" class="hyperref">Listing&nbsp;<span class="ref">9.18</span></a>.</p>
<div class="codelisting" id="_code-add_store_location" data-tralics-id="uid705" data-number="9.18"><div class="heading"><span class="number">Listing 9.18:</span> 

<span class="description">Adding <code>store_location</code> to the signed-in user before filter.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># Before filters</span>

    <span class="k">def</span> <span class="nf">signed_in_user</span>
      <span class="k">unless</span> <span class="n">signed_in?</span>
        <span class="n">store_location</span>
        <span class="n">redirect_to</span> <span class="n">signin_url</span><span class="p">,</span> <span class="ss">notice</span><span class="p">:</span> <span class="s2">"Please sign in."</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_url</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>To implement the forwarding itself, we use the <code>redirect_back_or</code> method to redirect to the requested URL if it exists, or some default URL otherwise, which we add to the Sessions controller <code>create</code> action to redirect after successful signin (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-friendly_session_create" class="hyperref">Listing&nbsp;<span class="ref">9.19</span></a>).<span class="intersentencespace"></span> The <code>redirect_back_or</code> method uses the or operator&nbsp;<code>||</code> through</p>
<div class="code"><div class="highlight"><pre><span class="n">session</span><span class="o">[</span><span class="ss">:return_to</span><span class="o">]</span> <span class="o">||</span> <span class="n">default</span>
</pre></div></div>
<p>This evaluates to <code>session[:return_to]</code> unless it’s <code>nil</code>, in which case it evaluates to the given default URL. Note that <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-friendly_forwarding_code" class="hyperref">Listing&nbsp;<span class="ref">9.17</span></a> is careful to remove the forwarding URL; otherwise, subsequent signin attempts would forward to the protected page until the user closed their browser.<span class="intersentencespace"></span> (Testing for this is left as an exercise (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-updating_deleting_exercises" class="hyperref">Section&nbsp;<span class="ref">9.6</span></a>).)</p>
<div class="codelisting" id="_code-friendly_session_create" data-tralics-id="uid706" data-number="9.19"><div class="heading"><span class="number">Listing 9.19:</span> 

<span class="description">The Sessions <code>create</code> action with friendly forwarding.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">redirect_back_or</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>(If you completed the first exercise in <a href="http://www.railstutorial.org/book/sign_in_out#cha-sign_in_sign_out" class="hyperref">Chapter&nbsp;<span class="ref">8</span></a>, be sure to use the proper <code>params</code> hash in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-friendly_session_create" class="hyperref">Listing&nbsp;<span class="ref">9.19</span></a>.)</p>
<p>With that, the friendly forwarding integration test in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-friendly_forwarding_test" class="hyperref">Listing&nbsp;<span class="ref">9.16</span></a> should pass, and the basic user authentication and page protection implementation is complete.<span class="intersentencespace"></span> As usual, it’s a good idea to verify that the test suite is green before proceeding:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div></div><div id="_sec-showing_all_users" data-tralics-id="cid55" class="section" data-number="9.3"><h2><a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-showing_all_users" class="heading hyperref"><span class="number">9.3 </span>Showing all users</a></h2>
<p>In this section, we’ll add the <a href="http://www.answers.com/penultimate">penultimate</a> user action, the <code>index</code> action, which is designed to display <em>all</em> the users instead of just one.<span class="intersentencespace"></span> Along the way, we’ll learn about populating the database with sample users and <em>paginating</em> the user output so that the index page can scale up to display a potentially large number of users.<span class="intersentencespace"></span> A mockup of the result—users, pagination links, and a “Users” navigation link—appears in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#fig-user_index_mockup" class="hyperref">Figure&nbsp;<span class="ref">9.7</span></a>.<sup id="_cha-9_footnote-ref-6" class="footnote intersentence"><a href="http://www.railstutorial.org/book/updating_and_deleting_users#cha-9_footnote-6">6</a></sup><span class="intersentencespace"></span> In <a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-destroying_users" class="hyperref">Section&nbsp;<span class="ref">9.4</span></a>, we’ll add an administrative interface to the user index so that (presumably troublesome) users can be destroyed.</p>
<div class="center figure" id="_fig-user_index_mockup" data-tralics-id="uid708" data-number="9.7">
<div class="graphics image box"><img src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/user_index_mockup_bootstrap.png" alt="images/figures/user_index_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 9.7: </span><span class="description">A mockup of the user index, with pagination and a “Users” nav link.
</span></div></div>
<div id="_sec-user_index" data-tralics-id="uid709" class="subsection" data-number="9.3.1"><h3><a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-user_index" class="heading hyperref"><span class="number">9.3.1 </span>User index</a></h3>
<p>Although we’ll keep individual user <code>show</code> pages visible to all site visitors, the user <code>index</code> will be restricted to signed-in users so that there’s a limit to how much unregistered users can see by default.<span class="intersentencespace"></span> We’ll start by testing that the <code>index</code> action is protected by visiting the <code>users_path</code> (<a href="http://www.railstutorial.org/book/sign_up#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a>) and verifying that we are redirected to the signin page.<span class="intersentencespace"></span> As with other authorization tests, we’ll put this example in the authentication integration test, as shown in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-protected_index_test" class="hyperref">Listing&nbsp;<span class="ref">9.20</span></a>.</p>
<div class="codelisting" id="_code-protected_index_test" data-tralics-id="uid710" data-number="9.20"><div class="heading"><span class="number">Listing 9.20:</span> 

<span class="description">Testing that the <code>index</code> action is protected.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"authorization"</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">"for non-signed-in users"</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">"in the Users controller"</span> <span class="k">do</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="n">describe</span> <span class="s2">"visiting the user index"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">users_path</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The corresponding application code simply involves adding <code>index</code> to the list of actions protected by the <code>signed_in_user</code> before filter, as shown in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-signed_in_user_index" class="hyperref">Listing&nbsp;<span class="ref">9.21</span></a>.</p>
<div class="codelisting" id="_code-signed_in_user_index" data-tralics-id="uid711" data-number="9.21"><div class="heading"><span class="number">Listing 9.21:</span> 

<span class="description">Requiring a signed-in user for the <code>index</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>

  <span class="k">def</span> <span class="nf">index</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>The next set of tests makes sure that, for signed-in users, the index page has the right title/content and lists all of the site’s users.<span class="intersentencespace"></span> The method is to make three factory users (signing in as the first one) and then verify that the index page has a list element (<code>li</code>) tag for the name of each one.<span class="intersentencespace"></span> Note that we’ve taken care to give the users different names so that each element in the list of users has a unique entry, as shown in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-user_index_tests" class="hyperref">Listing&nbsp;<span class="ref">9.22</span></a>.</p>
<div class="codelisting" id="_code-user_index_tests" data-tralics-id="uid712" data-number="9.22"><div class="heading"><span class="number">Listing 9.22:</span> 

<span class="description">Tests for the user index page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/user_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"index"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="n">sign_in</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">"Bob"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"bob@example.com"</span><span class="p">)</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">"Ben"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"ben@example.com"</span><span class="p">)</span>
      <span class="n">visit</span> <span class="n">users_path</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'All users'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'All users'</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s2">"should list each user"</span> <span class="k">do</span>
      <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'li'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>As you may recall from the corresponding action in the demo app (<a href="http://www.railstutorial.org/book/demo_app#code-demo_index_action" class="hyperref">Listing&nbsp;<span class="ref">2.4</span></a>), the application code uses <code>User.all</code> to pull all the users out of the database, assigning them to an <code>@users</code> instance variable for use in the view, as seen in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-user_index" class="hyperref">Listing&nbsp;<span class="ref">9.23</span></a>.<span class="intersentencespace"></span> (If displaying all the users at once seems like a bad idea, you’re right, and we’ll remove this blemish in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-pagination" class="hyperref">Section&nbsp;<span class="ref">9.3.3</span></a>.)</p>
<div class="codelisting" id="_code-user_index" data-tralics-id="uid713" data-number="9.23"><div class="heading"><span class="number">Listing 9.23:</span> 

<span class="description">The user <code>index</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>To make the actual index page, we need to make a view that iterates through the users and wraps each one in an&nbsp;<code>li</code> tag.<span class="intersentencespace"></span> We do this with the <code>each</code> method, displaying each user’s Gravatar and name, while wrapping the whole thing in an unordered list (<code>ul</code>) tag (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-user_index_view" class="hyperref">Listing&nbsp;<span class="ref">9.24</span></a>).<span class="intersentencespace"></span> The code in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-user_index_view" class="hyperref">Listing&nbsp;<span class="ref">9.24</span></a> uses the result of <a href="http://www.railstutorial.org/book/sign_up#code-gravatar_option" class="hyperref">Listing&nbsp;<span class="ref">7.30</span></a> from <a href="http://www.railstutorial.org/book/sign_up#sec-signup_exercises" class="hyperref">Section&nbsp;<span class="ref">7.6</span></a>, which allows us to pass an option to the Gravatar helper specifying a size other than the default.<span class="intersentencespace"></span> If you didn’t do that exercise, update your Users helper file with the contents of <a href="http://www.railstutorial.org/book/sign_up#code-gravatar_option" class="hyperref">Listing&nbsp;<span class="ref">7.30</span></a> before proceeding.</p>
<div class="codelisting" id="_code-user_index_view" data-tralics-id="uid714" data-number="9.24"><div class="heading"><span class="number">Listing 9.24:</span> 

<span class="description">The user index view.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/index.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'All users'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">52</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</pre></div></div></div><p>Let’s also add a little CSS (or, rather, SCSS) for style (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-user_index_css" class="hyperref">Listing&nbsp;<span class="ref">9.25</span></a>).</p>
<div class="codelisting" id="_code-user_index_css" data-tralics-id="uid715" data-number="9.25"><div class="heading"><span class="number">Listing 9.25:</span> 

<span class="description">CSS for the user index.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.css.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">Users</span> <span class="nt">index</span> <span class="o">*/</span>

<span class="nc">.users</span> <span class="p">{</span>
  <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
  <span class="na">margin</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nt">li</span> <span class="p">{</span>
    <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$grayLighter</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:last-child</span> <span class="p">{</span>
      <span class="na">border-bottom</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$grayLighter</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div><p>Finally, we’ll add the URL to the users link in the site’s navigation header using <code>users_path</code>, thereby using the last of the unused named routes in <a href="http://www.railstutorial.org/book/sign_up#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a>.<span class="intersentencespace"></span> The test (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-users_link_test" class="hyperref">Listing&nbsp;<span class="ref">9.26</span></a>) and application code (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-users_link" class="hyperref">Listing&nbsp;<span class="ref">9.27</span></a>) are both straightforward.</p>
<div class="codelisting" id="_code-users_link_test" data-tralics-id="uid716" data-number="9.26"><div class="heading"><span class="number">Listing 9.26:</span> 

<span class="description">A test for the “Users” link URL. <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Users'</span><span class="p">,</span>       <span class="ss">href</span><span class="p">:</span> <span class="n">users_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Profile'</span><span class="p">,</span>     <span class="ss">href</span><span class="p">:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Settings'</span><span class="p">,</span>    <span class="ss">href</span><span class="p">:</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign out'</span><span class="p">,</span>    <span class="ss">href</span><span class="p">:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-users_link" data-tralics-id="uid717" data-number="9.27"><div class="heading"><span class="number">Listing 9.27:</span> 

<span class="description">Adding the URL to the users link.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/layouts/_header.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"navbar navbar-fixed-top navbar-inverse"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-inner"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"sample app"</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">"logo"</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav pull-right"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Home"</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Help"</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Users"</span><span class="p">,</span> <span class="n">users_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">"fat-menu"</span> <span class="na">class=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"dropdown-toggle"</span> <span class="na">data-toggle=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
                Account <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">"caret"</span><span class="nt">&gt;&lt;/b&gt;</span>
              <span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"dropdown-menu"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"divider"</span><span class="nt">&gt;&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign out"</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">"delete"</span> <span class="cp">%&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign in"</span><span class="p">,</span> <span class="n">signin_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div></div></div><p>With that, the user index is fully functional, with all tests passing:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
<p>On the other hand, as seen in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#fig-user_index_only_one" class="hyperref">Figure&nbsp;<span class="ref">9.8</span></a>, it is a bit…lonely.<span class="intersentencespace"></span> Let’s remedy this sad situation.</p>
<div class="center figure" id="_fig-user_index_only_one" data-tralics-id="uid718" data-number="9.8">
<div class="graphics image box"><img src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/user_index_only_one_bootstrap.png" alt="images/figures/user_index_only_one_bootstrap"></div><div class="caption"><span class="header">Figure 9.8: </span><span class="description">The user index page <a href="http://localhost:3000/users">/users</a> with only one user.
</span></div></div>
</div>
<div id="_sec-sample_users" data-tralics-id="uid719" class="subsection" data-number="9.3.2"><h3><a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-sample_users" class="heading hyperref"><span class="number">9.3.2 </span>Sample users</a></h3>
<p>In this section, we’ll give our lonely sample user some company.<span class="intersentencespace"></span> Of course, to create enough users to make a decent user index, we <em>could</em> use our web browser to visit the signup page and make the new users one by one, but far a better solution is to use Ruby (and Rake) to make the users for us.</p>
<p>First, we’ll add the <em>Faker</em> gem to the <code>Gemfile</code>, which will allow us to make sample users with semi-realistic names and email addresses (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-faker_gemfile" class="hyperref">Listing&nbsp;<span class="ref">9.28</span></a>).</p>
<div class="codelisting" id="_code-faker_gemfile" data-tralics-id="uid720" data-number="9.28"><div class="heading"><span class="number">Listing 9.28:</span> 

<span class="description">Adding the Faker gem to the <code>Gemfile</code>.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">ruby</span> <span class="s1">'2.0.0'</span>
<span class="c1">#ruby-gemset=railstutorial_rails_4_0</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'4.0.8'</span>
<span class="n">gem</span> <span class="s1">'bootstrap-sass'</span><span class="p">,</span> <span class="s1">'2.3.2.0'</span>
<span class="n">gem</span> <span class="s1">'sprockets'</span><span class="p">,</span> <span class="s1">'2.11.0'</span>
<span class="n">gem</span> <span class="s1">'bcrypt-ruby'</span><span class="p">,</span> <span class="s1">'3.1.2'</span>
<span class="n">gem</span> <span class="s1">'faker'</span><span class="p">,</span> <span class="s1">'1.1.2'</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div></div></div><p>Then install as usual:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div></div>
<p>Next, we’ll add a Rake task to create sample users.<span class="intersentencespace"></span> Rake tasks live in the <code>lib/tasks</code> directory, and are defined using <em>namespaces</em> (in this case, <code>:db</code>), as seen in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-db_populate" class="hyperref">Listing&nbsp;<span class="ref">9.29</span></a>.<span class="intersentencespace"></span> (This is a bit advanced, so don’t worry too much about the details.)</p>
<div class="codelisting" id="_code-db_populate" data-tralics-id="uid721" data-number="9.29"><div class="heading"><span class="number">Listing 9.29:</span> 

<span class="description">A Rake task for populating the database with sample users.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">lib/tasks/sample_data.rake</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">"Fill database with sample data"</span>
  <span class="n">task</span> <span class="ss">populate</span><span class="p">:</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span>
                 <span class="ss">email</span><span class="p">:</span> <span class="s2">"example@railstutorial.org"</span><span class="p">,</span>
                 <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span>
                 <span class="n">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
    <span class="mi">99</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
      <span class="nb">name</span>  <span class="o">=</span> <span class="ss">Faker</span><span class="p">:</span><span class="ss">:Name</span><span class="o">.</span><span class="n">name</span>
      <span class="n">email</span> <span class="o">=</span> <span class="s2">"example-</span><span class="si">#{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">@railstutorial.org"</span>
      <span class="n">password</span>  <span class="o">=</span> <span class="s2">"password"</span>
      <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="nb">name</span><span class="p">,</span>
                   <span class="ss">email</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
                   <span class="ss">password</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
                   <span class="n">password_confirmation</span><span class="p">:</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>This defines a task <code>db:populate</code> that creates an example user with name and email address replicating our previous one, and then makes 99 more.<span class="intersentencespace"></span> The line</p>
<div class="code"><div class="highlight"><pre><span class="n">task</span> <span class="ss">populate</span><span class="p">:</span> <span class="ss">:environment</span> <span class="k">do</span>
</pre></div></div>
<p>ensures that the Rake task has access to the local Rails environment, including the User model (and hence <code>User.create!</code>).<span class="intersentencespace"></span> Here <code>create!</code> is just like the <code>create</code> method, except it raises an exception (<a href="http://www.railstutorial.org/book/modeling_users#sec-finding_user_objects" class="hyperref">Section&nbsp;<span class="ref">6.1.4</span></a>) for an invalid user rather than returning <code>false</code>.<span class="intersentencespace"></span> This noisier construction makes debugging easier by avoiding silent errors.</p>
<p>With the <code>:db</code> namespace as in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-db_populate" class="hyperref">Listing&nbsp;<span class="ref">9.29</span></a>, we can invoke the Rake task as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:populate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake <span class="nb">test</span>:prepare
</pre></div></div>
<p>After running the Rake task, our application has 100 sample users, as seen in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#fig-user_index_all" class="hyperref">Figure&nbsp;<span class="ref">9.9</span></a>.<span class="intersentencespace"></span> (I’ve taken the liberty of associating the first few sample addresses with photos so that they’re not all the default Gravatar image.)</p>
<div class="center figure" id="_fig-user_index_all" data-tralics-id="uid722" data-number="9.9">
<div class="graphics image box"><img src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/user_index_all_bootstrap.png" alt="images/figures/user_index_all_bootstrap"></div><div class="caption"><span class="header">Figure 9.9: </span><span class="description">The user index page <a href="http://localhost:3000/users">/users</a> with 100 sample users.
</span></div></div>
</div>
<div id="_sec-pagination" data-tralics-id="uid723" class="subsection" data-number="9.3.3"><h3><a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-pagination" class="heading hyperref"><span class="number">9.3.3 </span>Pagination</a></h3>
<p>Our original user doesn’t suffer from loneliness any more, but now we have the opposite problem: our user has <em>too many</em> companions, and they all appear on the same page.<span class="intersentencespace"></span> Right now there are a hundred, which is already a reasonably large number, and on a real site it could be thousands.<span class="intersentencespace"></span> The solution is to <em>paginate</em> the users, so that (for example) only 30 show up on a page at any one time.</p>
<p>There are several pagination methods in Rails; we’ll use one of the simplest and most robust, called <a href="http://wiki.github.com/mislav/will_paginate/">will_paginate</a>.<span class="intersentencespace"></span> To use it, we need to include both the <span class="tt">will_paginate</span> gem and <span class="tt">bootstrap-will_paginate</span>, which configures will_paginate to use Bootstrap’s pagination styles.<span class="intersentencespace"></span> The updated <code>Gemfile</code> appears in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-will_paginate_gem" class="hyperref">Listing&nbsp;<span class="ref">9.30</span></a>.</p>
<div class="codelisting" id="_code-will_paginate_gem" data-tralics-id="uid724" data-number="9.30"><div class="heading"><span class="number">Listing 9.30:</span> 

<span class="description">Including <span class="tt">will_paginate</span> in the <code>Gemfile</code>.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">ruby</span> <span class="s1">'2.0.0'</span>
<span class="c1">#ruby-gemset=railstutorial_rails_4_0</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'4.0.8'</span>
<span class="n">gem</span> <span class="s1">'bootstrap-sass'</span><span class="p">,</span> <span class="s1">'2.3.2.0'</span>
<span class="n">gem</span> <span class="s1">'sprockets'</span><span class="p">,</span> <span class="s1">'2.11.0'</span>
<span class="n">gem</span> <span class="s1">'bcrypt-ruby'</span><span class="p">,</span> <span class="s1">'3.1.2'</span>
<span class="n">gem</span> <span class="s1">'faker'</span><span class="p">,</span> <span class="s1">'1.1.2'</span>
<span class="n">gem</span> <span class="s1">'will_paginate'</span><span class="p">,</span> <span class="s1">'3.0.4'</span>
<span class="n">gem</span> <span class="s1">'bootstrap-will_paginate'</span><span class="p">,</span> <span class="s1">'0.0.9'</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div></div></div><p>Then run <code>bundle install</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div></div>
<p>You should also restart the web server to ensure that the new gems are loaded properly.</p>
<p>Because the <span class="tt">will_paginate</span> gem is in wide use, there’s no need to test it thoroughly, so we’ll take a lightweight approach.<span class="intersentencespace"></span> First, we’ll test for a <code>div</code> with CSS class “pagination”, which is what gets output by <span class="tt">will_paginate</span>.<span class="intersentencespace"></span> Then we’ll verify that the correct users appear on the first page of results.<span class="intersentencespace"></span> This requires the use of the <code>paginate</code> method, which we’ll cover shortly.</p>
<p>As before, we’ll use Factory Girl to simulate users, but immediately we have a problem: user email addresses must be unique, which would appear to require creating more than 30 users by hand—a terribly cumbersome job.<span class="intersentencespace"></span> In addition, when testing for user listings it would be convenient for them all to have different names.<span class="intersentencespace"></span> Fortunately, Factory Girl anticipates this issue, and provides <em>sequences</em> to solve it.<span class="intersentencespace"></span> Our original factory (<a href="http://www.railstutorial.org/book/sign_up#code-user_factory" class="hyperref">Listing&nbsp;<span class="ref">7.8</span></a>) hard-coded the name and email address:</p>
<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="nb">name</span>     <span class="s2">"Michael Hartl"</span>
    <span class="n">email</span>    <span class="s2">"michael@example.com"</span>
    <span class="n">password</span> <span class="s2">"foobar"</span>
    <span class="n">password_confirmation</span> <span class="s2">"foobar"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>Instead, we can arrange for a sequence of names and email addresses using the <code>sequence</code> method:</p>
<div class="code"><div class="highlight"><pre><span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
  <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
  <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"person_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com"</span><span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
</pre></div></div>
<p>Here <code>sequence</code> takes a symbol corresponding to the desired attribute (such as <code>:name</code>) and a block with one variable, which we have called&nbsp;<code>n</code>.<span class="intersentencespace"></span> Upon successive invocations of the <code>FactoryGirl</code> method,</p>
<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
</pre></div></div>
<p>The block variable <code>n</code> is automatically incremented, so that the first user has name “Person&nbsp;1” and email address “person_1@example.com”, the second user has name “Person&nbsp;2” and email address “person_2@example.com”, and so on.<span class="intersentencespace"></span> The full
code appears in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-factory_sequence" class="hyperref">Listing&nbsp;<span class="ref">9.31</span></a>.</p>
<div class="codelisting" id="_code-factory_sequence" data-tralics-id="uid725" data-number="9.31"><div class="heading"><span class="number">Listing 9.31:</span> 

<span class="description">Defining a Factory Girl sequence.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/factories.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"person_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com"</span><span class="p">}</span>
    <span class="n">password</span> <span class="s2">"foobar"</span>
    <span class="n">password_confirmation</span> <span class="s2">"foobar"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Applying the idea of factory sequences, we can make 30 users in our test, which (as we will see) will be sufficient to invoke pagination:</p>
<div class="code"><div class="highlight"><pre><span class="n">before</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span> <span class="p">{</span> <span class="mi">30</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
<span class="n">after</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span>  <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">delete_all</span> <span class="p">}</span>
</pre></div></div>
<p>Note here the use of <code>before(:all)</code>, which ensures that the sample users are created <em>once</em>, before all the tests in the block.<span class="intersentencespace"></span> This is an optimization for speed, as creating 30 users can be slow on some systems.<span class="intersentencespace"></span> We use the complementary method <code>after(:all)</code> to delete the users once we’re done.</p>
<p>The tests for the appearance of the pagination <code>div</code> and the right users appears in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-will_paginate_test" class="hyperref">Listing&nbsp;<span class="ref">9.32</span></a>.<span class="intersentencespace"></span> Note the replacement of the <code>User.all</code> array from <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-user_index_tests" class="hyperref">Listing&nbsp;<span class="ref">9.22</span></a> with <code>User.paginate(page: 1)</code>, which (as we’ll see momentarily) is how to pull out the first page of users from the database.<span class="intersentencespace"></span> Note also that <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-will_paginate_test" class="hyperref">Listing&nbsp;<span class="ref">9.32</span></a> uses <code>before(:each)</code> to emphasize the contrast with <code>before(:all)</code>.</p>
<div class="codelisting" id="_code-will_paginate_test" data-tralics-id="uid726" data-number="9.32"><div class="heading"><span class="number">Listing 9.32:</span> 

<span class="description">Tests for pagination.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/user_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"index"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">visit</span> <span class="n">users_path</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'All users'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'All users'</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"pagination"</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span> <span class="p">{</span> <span class="mi">30</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
      <span class="n">after</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span>  <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">delete_all</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.pagination'</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">it</span> <span class="s2">"should list each user"</span> <span class="k">do</span>
        <span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
          <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'li'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>To get pagination working, we need to add some code to the index view telling Rails to paginate the users, and we need to replace <code>User.all</code> in the <code>index</code> action with an object that knows about pagination.<span class="intersentencespace"></span> We’ll start by adding the special <code>will_paginate</code> method in the view (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-will_paginate_index_view" class="hyperref">Listing&nbsp;<span class="ref">9.33</span></a>); we’ll see in a moment why the code appears both above and below the user list.</p>
<div class="codelisting" id="_code-will_paginate_index_view" data-tralics-id="uid727" data-number="9.33"><div class="heading"><span class="number">Listing 9.33:</span> 

<span class="description">The user index with pagination.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/index.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'All users'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">52</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>The <code>will_paginate</code> method is a little magical; inside a <code>users</code> view, it automatically looks for an <code>@users</code> object, and then displays pagination links to access other pages.<span class="intersentencespace"></span> The view in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-will_paginate_index_view" class="hyperref">Listing&nbsp;<span class="ref">9.33</span></a> doesn’t work yet, though, because currently <code>@users</code> contains the results of <code>User.all</code> (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-user_index" class="hyperref">Listing&nbsp;<span class="ref">9.23</span></a>), whereas <code>will_paginate</code> requires that we paginate the results explicitly using the <code>paginate</code> method:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
<span class="go">  User Load (1.5ms)  SELECT "users".* FROM "users" LIMIT 30 OFFSET 0</span>
<span class="go">   (1.7ms)  SELECT COUNT(*) FROM "users"</span>
<span class="go">=&gt; #&lt;ActiveRecord::Relation [#&lt;User id: 1,...</span>
</pre></div></div>
<p>Note that <code>paginate</code> takes a hash argument with key <code>:page</code> and value equal to the page requested.<span class="intersentencespace"></span> <code>User.paginate</code> pulls the users out of the database one chunk at a time (30 by default), based on the <code>:page</code> parameter.<span class="intersentencespace"></span> So, for example, page&nbsp;1 is users 1–30, page&nbsp;2 is users 31–60, etc.<span class="intersentencespace"></span> If the page is <code>nil</code>, <code>paginate</code> simply returns the first page.</p>
<p>Using the <code>paginate</code> method, we can paginate the users in the sample application by using <code>paginate</code> in place of <code>all</code> in the <code>index</code> action (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-will_paginate_index_action" class="hyperref">Listing&nbsp;<span class="ref">9.34</span></a>).<span class="intersentencespace"></span> Here the <code>:page</code> parameter comes from <code>params[:page]</code>, which is generated automatically by <code>will_paginate</code>.</p>
<div class="codelisting" id="_code-will_paginate_index_action" data-tralics-id="uid728" data-number="9.34"><div class="heading"><span class="number">Listing 9.34:</span> 

<span class="description">Paginating the users in the <code>index</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>The user index page should now be working, appearing as in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#fig-user_index_pagination_rails_3" class="hyperref">Figure&nbsp;<span class="ref">9.10</span></a>.<span class="intersentencespace"></span> (On some systems, you may have to restart the Rails server at this point.)<span class="intersentencespace"></span> Because we included <code>will_paginate</code> both above and below the user list, the pagination links appear in both places.</p>
<div class="center figure" id="_fig-user_index_pagination_rails_3" data-tralics-id="uid729" data-number="9.10">
<div class="graphics image box"><img src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/user_index_pagination_rails_3_bootstrap.png" alt="images/figures/user_index_pagination_rails_3_bootstrap"></div><div class="caption"><span class="header">Figure 9.10: </span><span class="description">The user index page <a href="http://localhost:3000/users">/users</a> with pagination.
</span></div></div>
<p>If you now click on either the&nbsp;<a href="http://localhost:3000/users?page=2">2</a> link or <a href="http://localhost:3000/users?page=2">Next</a> link, you’ll get the second page of results, as shown in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#fig-user_index_page_two_rails_3" class="hyperref">Figure&nbsp;<span class="ref">9.11</span></a>.</p>
<div class="center figure" id="_fig-user_index_page_two_rails_3" data-tralics-id="uid730" data-number="9.11">
<div class="graphics image box"><img src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/user_index_page_two_rails_3_bootstrap.png" alt="images/figures/user_index_page_two_rails_3_bootstrap"></div><div class="caption"><span class="header">Figure 9.11: </span><span class="description">Page 2 of the user index (<a href="http://localhost:3000/users?page=2">/users?page=2</a>).
</span></div></div>
<p>You should also verify that the tests are passing:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div>
<div id="_sec-partial_refactoring" data-tralics-id="uid731" class="subsection" data-number="9.3.4"><h3><a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-partial_refactoring" class="heading hyperref"><span class="number">9.3.4 </span>Partial refactoring</a></h3>
<p>The paginated user index is now complete, but there’s one improvement I can’t resist including: Rails has some incredibly slick tools for making compact views, and in this section we’ll refactor the index page to use them.<span class="intersentencespace"></span> Because our code is well-tested, we can refactor with confidence, assured that we are unlikely to break our site’s functionality.</p>
<p>The first step in our refactoring is to replace the user&nbsp;<code>li</code> from <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-will_paginate_index_view" class="hyperref">Listing&nbsp;<span class="ref">9.33</span></a> with a <code>render</code> call (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-index_view_first_refactoring" class="hyperref">Listing&nbsp;<span class="ref">9.35</span></a>).</p>
<div class="codelisting" id="_code-index_view_first_refactoring" data-tralics-id="uid732" data-number="9.35"><div class="heading"><span class="number">Listing 9.35:</span> 

<span class="description">The first refactoring attempt at the index view.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/index.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'All users'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>Here we call <code>render</code> not on a string with the name of a partial, but rather on a <code>user</code> variable of class <code>User</code>;<sup id="_cha-9_footnote-ref-7" class="footnote"><a href="http://www.railstutorial.org/book/updating_and_deleting_users#cha-9_footnote-7">7</a></sup> in this context, Rails automatically looks for a partial called <code>_user.html.erb</code>, which we must create (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-user_partial" class="hyperref">Listing&nbsp;<span class="ref">9.36</span></a>).</p>
<div class="codelisting" id="_code-user_partial" data-tralics-id="uid734" data-number="9.36"><div class="heading"><span class="number">Listing 9.36:</span> 

<span class="description">A partial to render a single user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/_user.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">52</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div></div></div><p>This is a definite improvement, but we can do even better: we can call <code>render</code> <em>directly</em> on the <code>@users</code> variable (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-index_final_refactoring" class="hyperref">Listing&nbsp;<span class="ref">9.37</span></a>).</p>
<div class="codelisting" id="_code-index_final_refactoring" data-tralics-id="uid735" data-number="9.37"><div class="heading"><span class="number">Listing 9.37:</span> 

<span class="description">The fully refactored user index.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/index.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'All users'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>Here Rails infers that <code>@users</code> is a list of <code>User</code> objects; moreover, when called with a collection of users, Rails automatically iterates through them and renders each one with the <code>_user.html.erb</code> partial.<span class="intersentencespace"></span> The result is the impressively compact code in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-index_final_refactoring" class="hyperref">Listing&nbsp;<span class="ref">9.37</span></a>.<span class="intersentencespace"></span> As with any refactoring, you should verify that the test suite is still green after changing the application code:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div></div><div id="_sec-destroying_users" data-tralics-id="cid56" class="section" data-number="9.4"><h2><a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-destroying_users" class="heading hyperref"><span class="number">9.4 </span>Deleting users</a></h2>
<p>Now that the user index is complete, there’s only one canonical REST action left: <code>destroy</code>.<span class="intersentencespace"></span> In this section, we’ll add links to delete users, as mocked up in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#fig-user_index_delete_links_mockup" class="hyperref">Figure&nbsp;<span class="ref">9.12</span></a>, and define the <code>destroy</code> action necessary to accomplish the deletion.<span class="intersentencespace"></span> But first, we’ll create the class of administrative users authorized to do so.</p>
<div class="center figure" id="_fig-user_index_delete_links_mockup" data-tralics-id="uid736" data-number="9.12">
<div class="graphics image box"><img src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/user_index_delete_links_mockup_bootstrap.png" alt="images/figures/user_index_delete_links_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 9.12: </span><span class="description">A mockup of the user index with delete links.
</span></div></div>
<div id="_sec-administrative_users" data-tralics-id="uid737" class="subsection" data-number="9.4.1"><h3><a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-administrative_users" class="heading hyperref"><span class="number">9.4.1 </span>Administrative users</a></h3>
<p>We will identify privileged administrative users with a boolean <code>admin</code> attribute in the User model, which, as we’ll see, will automatically lead to an <code>admin?</code> boolean method to test for admin status.<span class="intersentencespace"></span> We can write tests for this attribute as in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-admin_specs" class="hyperref">Listing&nbsp;<span class="ref">9.38</span></a>.</p>
<div class="codelisting" id="_code-admin_specs" data-tralics-id="uid738" data-number="9.38"><div class="heading"><span class="number">Listing 9.38:</span> 

<span class="description">Tests for an <code>admin</code> attribute.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_admin</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"with admin attribute set to 'true'"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">save!</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_admin</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Here we’ve used the <code>toggle!</code> method to flip the <code>admin</code> attribute from <code>false</code> to <code>true</code>.<span class="intersentencespace"></span> Also note that the line</p>
<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_admin</span> <span class="p">}</span>
</pre></div></div>
<p>implies (via the RSpec boolean convention) that the user should have an <code>admin?</code> boolean method.</p>
<p>As usual, we add the <code>admin</code> attribute with a migration, indicating the <code>boolean</code> type on the command line:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_admin_to_users admin:boolean
</pre></div></div>
<p>The migration simply adds the <code>admin</code> column to the <code>users</code> table (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-admin_migration" class="hyperref">Listing&nbsp;<span class="ref">9.39</span></a>), yielding the data model in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#fig-user_model_admin" class="hyperref">Figure&nbsp;<span class="ref">9.13</span></a>.</p>
<div class="codelisting" id="_code-admin_migration" data-tralics-id="uid739" data-number="9.39"><div class="heading"><span class="number">Listing 9.39:</span> 

<span class="description">The migration to add a boolean <code>admin</code> attribute to users.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">db/migrate/[timestamp]_add_admin_to_users.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddAdminToUsers</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">,</span> <span class="ss">:boolean</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that we’ve added the argument <code>default: false</code> to <code>add_column</code> in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-admin_migration" class="hyperref">Listing&nbsp;<span class="ref">9.39</span></a>, which means that users will <em>not</em> be administrators by default.<span class="intersentencespace"></span> (Without the <code>default: false</code> argument, <code>admin</code> will be <code>nil</code> by default, which is still <code>false</code>, so this step is not strictly necessary.<span class="intersentencespace"></span> It is more explicit, though, and communicates our intentions more clearly both to Rails and to readers of our code.)</p>
<div class="center figure" id="_fig-user_model_admin" data-tralics-id="uid740" data-number="9.13"><span class="graphics"><img src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/user_model_admin_31.png" alt="user_model_admin_31"></span>
<div class="caption"><span class="header">Figure 9.13: </span><span class="description">The User model with an added <code>admin</code> boolean attribute.
</span></div></div>
<p>Finally, we migrate the development database and prepare the test database:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake <span class="nb">test</span>:prepare
</pre></div></div>
<p>As expected, Rails figures out the boolean nature of the <code>admin</code> attribute and automatically adds the question-mark method <code>admin?</code>:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p>As a result, the admin tests should pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
</pre></div></div>
<p>As a final step, let’s update our sample data populator to make the first user an admin by default (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-populator_with_admin" class="hyperref">Listing&nbsp;<span class="ref">9.40</span></a>).</p>
<div class="codelisting" id="_code-populator_with_admin" data-tralics-id="uid741" data-number="9.40"><div class="heading"><span class="number">Listing 9.40:</span> 

<span class="description">The sample data populator code with an admin user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">lib/tasks/sample_data.rake</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">"Fill database with sample data"</span>
  <span class="n">task</span> <span class="ss">populate</span><span class="p">:</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="n">admin</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span>
                         <span class="ss">email</span><span class="p">:</span> <span class="s2">"example@railstutorial.org"</span><span class="p">,</span>
                         <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span>
                         <span class="n">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span>
                         <span class="ss">admin</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Then reset the database and re-populate the sample data:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:populate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake <span class="nb">test</span>:prepare
</pre></div></div>
<div id="_sec-revisiting_strong_parameters" data-tralics-id="uid742" class="subsubsection" data-number="9.4.1.1"><h4><a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-revisiting_strong_parameters" class="heading">Revisiting strong parameters</a></h4>
<p>You might have noticed that <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-populator_with_admin" class="hyperref">Listing&nbsp;<span class="ref">9.40</span></a> makes the user an admin by including <code>admin: true</code> in the initialization hash.<span class="intersentencespace"></span> This underscores the danger of exposing our objects to the wild Web: if we simply passed an initialization hash in from an arbitrary web request, a malicious user could send a <span class="tt">PATCH</span> request as follows:<sup id="_cha-9_footnote-ref-8" class="footnote"><a href="http://www.railstutorial.org/book/updating_and_deleting_users#cha-9_footnote-8">8</a></sup></p>
<div class="code"><div class="highlight"><pre>patch /users/17?admin=1
</pre></div></div>
<p>This request would make user 17 an admin, which would be a potentially serious security breach, to say the least.</p>
<p>Because of this danger, it is essential to pass parameters that have been processed to permit only safe-to-edit attributes.<span class="intersentencespace"></span> As noted in <a href="http://www.railstutorial.org/book/sign_up#sec-strong_parameters" class="hyperref">Section&nbsp;<span class="ref">7.3.2</span></a>, this is accomplished using <em>strong parameters</em> by calling <code>require</code> and <code>permit</code> on the <code>params</code> hash:</p>
<div class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>
</pre></div></div>
<p>Note in particular that <code>admin</code> is <em>not</em> in the list of permitted attributes.<span class="intersentencespace"></span> This is what prevents arbitrary users from granting themselves administrative access to our application.<span class="intersentencespace"></span> Because of its importance, it’s a good idea to write a test for any attribute that isn’t editible, and writing such a test for the <code>admin</code> attribute is left as an exercise (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-updating_deleting_exercises" class="hyperref">Section&nbsp;<span class="ref">9.6</span></a>).</p>
</div></div>
<div id="_sec-the_destroy_action" data-tralics-id="uid744" class="subsection" data-number="9.4.2"><h3><a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-the_destroy_action" class="heading hyperref"><span class="number">9.4.2 </span>The <span class="tt">destroy</span> action</a></h3>
<p>The final step needed to complete the Users resource is to add delete links and a <code>destroy</code> action.<span class="intersentencespace"></span> We’ll start by adding a delete link for each user on the user index page, restricting access to administrative users.</p>
<p>To write tests for the delete functionality, it’s helpful to be able to have a factory to create admins.<span class="intersentencespace"></span> We can accomplish this by adding an <code>:admin</code> block to our factories, as shown in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-admin_factory" class="hyperref">Listing&nbsp;<span class="ref">9.41</span></a>.</p>
<div class="codelisting" id="_code-admin_factory" data-tralics-id="uid745" data-number="9.41"><div class="heading"><span class="number">Listing 9.41:</span> 

<span class="description">Adding a factory for administrative users.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/factories.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"person_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com"</span><span class="p">}</span>
    <span class="n">password</span> <span class="s2">"foobar"</span>
    <span class="n">password_confirmation</span> <span class="s2">"foobar"</span>

    <span class="n">factory</span> <span class="ss">:admin</span> <span class="k">do</span>
      <span class="n">admin</span> <span class="kp">true</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>With the code in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-admin_factory" class="hyperref">Listing&nbsp;<span class="ref">9.41</span></a>, we can now use <code>FactoryGirl.create(:admin)</code> to create an administrative user in our tests.</p>
<p>Our security model requires that ordinary users not see delete links:</p>
<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">)</span> <span class="p">}</span>
</pre></div></div>
<p>But administrative users should see such links, and by clicking on a delete link we expect an admin to delete the user, i.e., to change the <code>User</code> count by&nbsp;<code>-1</code>:</p>
<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">user_path</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="p">))</span> <span class="p">}</span>
<span class="n">it</span> <span class="s2">"should be able to delete another user"</span> <span class="k">do</span>
  <span class="n">expect</span> <span class="k">do</span>
    <span class="n">click_link</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">,</span> <span class="ss">match</span><span class="p">:</span> <span class="ss">:first</span><span class="p">)</span>
  <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">admin</span><span class="p">))</span> <span class="p">}</span>
</pre></div></div>
<p>This includes the code <code>match: :first</code>, which tells Capybara that we don’t care <em>which</em> delete link it clicks; it should just click the first one it sees.<span class="intersentencespace"></span> Note also that we have added a test to verify that the admin does not see a link to delete himself.<span class="intersentencespace"></span> The full set of delete link tests appears in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-delete_link_tests" class="hyperref">Listing&nbsp;<span class="ref">9.42</span></a>.</p>
<div class="codelisting" id="_code-delete_link_tests" data-tralics-id="uid746" data-number="9.42"><div class="heading"><span class="number">Listing 9.42:</span> 

<span class="description">Tests for delete links.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/user_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"index"</span> <span class="k">do</span>

    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">before</span> <span class="k">do</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">visit</span> <span class="n">users_path</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'All users'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'All users'</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"pagination"</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">"delete links"</span> <span class="k">do</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">"as an admin user"</span> <span class="k">do</span>
        <span class="n">let</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">sign_in</span> <span class="n">admin</span>
          <span class="n">visit</span> <span class="n">users_path</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">user_path</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="p">))</span> <span class="p">}</span>
        <span class="n">it</span> <span class="s2">"should be able to delete another user"</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="k">do</span>
            <span class="n">click_link</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">,</span> <span class="ss">match</span><span class="p">:</span> <span class="ss">:first</span><span class="p">)</span>
          <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">admin</span><span class="p">))</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>The application code links to <code>"delete"</code> if the current user is an admin (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-delete_links" class="hyperref">Listing&nbsp;<span class="ref">9.43</span></a>).<span class="intersentencespace"></span> Note the <code>method: :delete</code> argument, which arranges for the link to issue the necessary <span class="tt">DELETE</span> request.<span class="intersentencespace"></span> We’ve also wrapped each link inside an&nbsp;<code>if</code> statement so that only admins can see them.<span class="intersentencespace"></span> The result for our admin user appears in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#fig-index_delete_links_rails_3" class="hyperref">Figure&nbsp;<span class="ref">9.14</span></a>.</p>
<div class="codelisting" id="_code-delete_links" data-tralics-id="uid747" data-number="9.43"><div class="heading"><span class="number">Listing 9.43:</span> 

<span class="description">User delete links (viewable only by admins).<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/_user.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">52</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">admin?</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    | <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"delete"</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
                                  <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">confirm</span><span class="p">:</span> <span class="s2">"You sure?"</span> <span class="p">}</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div></div></div><p>Web browsers can’t send <span class="tt">DELETE</span> requests natively, so Rails fakes them with JavaScript.<span class="intersentencespace"></span> This means that the delete links won’t work if the user has JavaScript disabled.<span class="intersentencespace"></span> If you must support non-JavaScript-enabled browsers you can fake a <span class="tt">DELETE</span> request using a form and a <span class="tt">POST</span> request, which works even without JavaScript; see the RailsCast on “<a href="http://railscasts.com/episodes/77-destroy-without-javascript">Destroy Without JavaScript</a>” for details.</p>
<div class="center figure" id="_fig-index_delete_links_rails_3" data-tralics-id="uid748" data-number="9.14">
<div class="graphics image box"><img src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/index_delete_links_rails_3_bootstrap.png" alt="images/figures/index_delete_links_rails_3_bootstrap"></div><div class="caption"><span class="header">Figure 9.14: </span><span class="description">The user index <a href="http://localhost:3000/users">/users</a> with delete links.
</span></div></div>
<p>To get the delete links to work, we need to add a <code>destroy</code> action (<a href="http://www.railstutorial.org/book/sign_up#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a>), which finds the corresponding user and destroys it with the Active Record <code>destroy</code> method, finally redirecting to the user index, as seen in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-destroy_action" class="hyperref">Listing&nbsp;<span class="ref">9.44</span></a>.<span class="intersentencespace"></span> Note that we also add <code>:destroy</code> to the <code>signed_in_user</code> before filter.</p>
<div class="codelisting" id="_code-destroy_action" data-tralics-id="uid749" data-number="9.44"><div class="heading"><span class="number">Listing 9.44:</span> 

<span class="description">Adding a working <code>destroy</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
    <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"User deleted."</span>
    <span class="n">redirect_to</span> <span class="n">users_url</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that the <code>destroy</code> action uses method chaining to combine the <code>find</code> and <code>destroy</code> into one line:</p>
<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
</pre></div></div>
<p>As constructed, only admins can destroy users through the web, because only admins can see the delete links.<span class="intersentencespace"></span> Unfortunately, there’s still a terrible security hole: any sufficiently sophisticated attacker could simply issue <span class="tt">DELETE</span> requests directly from the command line to delete any user on the site.<span class="intersentencespace"></span> To secure the site properly, we also need access control on the <code>destroy</code> action, so our tests should check not only that admins <em>can</em> delete users, but also that other users <em>can’t</em>.<span class="intersentencespace"></span> The results appear in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-delete_destroy_test" class="hyperref">Listing&nbsp;<span class="ref">9.45</span></a>.<span class="intersentencespace"></span> Note that, in analogy with the <code>patch</code> method from <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-protected_edit_update_tests" class="hyperref">Listing&nbsp;<span class="ref">9.11</span></a>, we use <code>delete</code> to issue a <span class="tt">DELETE</span> request directly to the specified URL (in this case, the user path, as required by <a href="http://www.railstutorial.org/book/sign_up#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a>).</p>
<div class="codelisting" id="_code-delete_destroy_test" data-tralics-id="uid750" data-number="9.45"><div class="heading"><span class="number">Listing 9.45:</span> 

<span class="description">A test for protecting the <code>destroy</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"authorization"</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"as non-admin user"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:non_admin</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">non_admin</span><span class="p">,</span> <span class="n">no_capybara</span><span class="p">:</span> <span class="kp">true</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">"submitting a DELETE request to the Users#destroy action"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">delete</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_url</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>In principle, there’s still a minor security hole, which is that an admin could delete himself by issuing a <span class="tt">DELETE</span> request directly.<span class="intersentencespace"></span> One might argue that such an admin is only getting what they deserve, but it would be nice to prevent such an occurrence, and doing so is left as an exercise (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-updating_deleting_exercises" class="hyperref">Section&nbsp;<span class="ref">9.6</span></a>).</p>
<p>As you might suspect by now, the application code uses a before filter, this time to restrict access to the <code>destroy</code> action to admins.<span class="intersentencespace"></span> The resulting <code>admin_user</code> before filter appears in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-admin_destroy_before_filter" class="hyperref">Listing&nbsp;<span class="ref">9.46</span></a>.</p>
<div class="codelisting" id="_code-admin_destroy_before_filter" data-tralics-id="uid751" data-number="9.46"><div class="heading"><span class="number">Listing 9.46:</span> 

<span class="description">A before filter restricting the <code>destroy</code> action to admins.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_action</span> <span class="ss">:admin_user</span><span class="p">,</span>     <span class="ss">only</span><span class="p">:</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="k">def</span> <span class="nf">admin_user</span>
      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_url</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user</span><span class="o">.</span><span class="n">admin?</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>At this point, all the tests should be passing, and the Users resource—with its controller, model, and views—is functionally complete.</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div></div><div id="_sec-updating_and_deleting_users_conclusion" data-tralics-id="cid57" class="section" data-number="9.5"><h2><a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-updating_and_deleting_users_conclusion" class="heading hyperref"><span class="number">9.5 </span>Conclusion</a></h2>
<p>We’ve come a long way since introducing the Users controller way back in <a href="http://www.railstutorial.org/book/filling_in_the_layout#sec-user_signup" class="hyperref">Section&nbsp;<span class="ref">5.4</span></a>.<span class="intersentencespace"></span> Those users couldn’t even sign up; now users can sign up, sign in, sign out, view their profiles, edit their settings, and see an index of all users—and some can even destroy other users.</p>
<p>The rest of this book builds on the foundation of the Users resource (and associated authorization system) to make a site with Twitter-like microposts (<a href="http://www.railstutorial.org/book/user_microposts#cha-user_microposts" class="hyperref">Chapter&nbsp;<span class="ref">10</span></a>) and a status feed of posts from followed users (<a href="http://www.railstutorial.org/book/following_users#cha-following_users" class="hyperref">Chapter&nbsp;<span class="ref">11</span></a>).<span class="intersentencespace"></span> These chapters will introduce some of the most powerful features of Rails, including data modeling with <code>has_many</code> and <code>has_many through</code>.</p>
<p>Before moving on, be sure to merge all the changes into the master branch:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">"Finish user edit, update, index, and destroy actions"</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge updating-users
</pre></div></div>
<p>You can also deploy the application and even populate the production database with sample users (using the <code>pg:reset</code> task to reset the production database):</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku pg:reset DATABASE
<span class="gp">$</span> heroku run rake db:migrate
<span class="gp">$</span> heroku run rake db:populate
</pre></div></div>
<p>To get the changes to show up, you may have to force an app restart at Heroku:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku restart
</pre></div></div>
<p>It’s also worth noting that this chapter saw the last of the necessary gem installations.<span class="intersentencespace"></span> For reference, the final <code>Gemfile</code> is shown in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-final_gemfile" class="hyperref">Listing&nbsp;<span class="ref">9.47</span></a>.<span class="intersentencespace"></span> (Optional gems may be system-dependent and are commented out.<span class="intersentencespace"></span> You can uncomment them to see if they work on your system.)</p>
<div class="codelisting" id="_code-final_gemfile" data-tralics-id="uid752" data-number="9.47"><div class="heading"><span class="number">Listing 9.47:</span> 

<span class="description">The final <code>Gemfile</code> for the sample application.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">ruby</span> <span class="s1">'2.0.0'</span>
<span class="c1">#ruby-gemset=railstutorial_rails_4_0</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'4.0.8'</span>
<span class="n">gem</span> <span class="s1">'bootstrap-sass'</span><span class="p">,</span> <span class="s1">'2.3.2.0'</span>
<span class="n">gem</span> <span class="s1">'sprockets'</span><span class="p">,</span> <span class="s1">'2.11.0'</span>
<span class="n">gem</span> <span class="s1">'bcrypt-ruby'</span><span class="p">,</span> <span class="s1">'3.1.2'</span>
<span class="n">gem</span> <span class="s1">'faker'</span><span class="p">,</span> <span class="s1">'1.1.2'</span>
<span class="n">gem</span> <span class="s1">'will_paginate'</span><span class="p">,</span> <span class="s1">'3.0.4'</span>
<span class="n">gem</span> <span class="s1">'bootstrap-will_paginate'</span><span class="p">,</span> <span class="s1">'0.0.9'</span>

<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sqlite3'</span><span class="p">,</span> <span class="s1">'1.3.8'</span>
  <span class="n">gem</span> <span class="s1">'rspec-rails'</span><span class="p">,</span> <span class="s1">'2.13.1'</span>
  <span class="c1"># The following optional lines are part of the advanced setup.</span>
  <span class="c1"># gem 'guard-rspec', '2.5.0'</span>
  <span class="c1"># gem 'spork-rails', '4.0.0'</span>
  <span class="c1"># gem 'guard-spork', '1.5.0'</span>
  <span class="c1"># gem 'childprocess', '0.3.6'</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'selenium-webdriver'</span><span class="p">,</span> <span class="s1">'2.35.1'</span>
  <span class="n">gem</span> <span class="s1">'capybara'</span><span class="p">,</span> <span class="s1">'2.1.0'</span>
  <span class="n">gem</span> <span class="s1">'factory_girl_rails'</span><span class="p">,</span> <span class="s1">'4.2.0'</span>
  <span class="n">gem</span> <span class="s1">'cucumber-rails'</span><span class="p">,</span> <span class="s1">'1.4.0'</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="kp">false</span>
  <span class="n">gem</span> <span class="s1">'database_cleaner'</span><span class="p">,</span> <span class="ss">github</span><span class="p">:</span> <span class="s1">'bmabey/database_cleaner'</span>

  <span class="c1"># Uncomment this line on OS X.</span>
  <span class="c1"># gem 'growl', '1.0.3'</span>

  <span class="c1"># Uncomment these lines on Linux.</span>
  <span class="c1"># gem 'libnotify', '0.8.0'</span>

  <span class="c1"># Uncomment these lines on Windows.</span>
  <span class="c1"># gem 'rb-notifu', '0.0.4'</span>
  <span class="c1"># gem 'wdm', '0.1.0'</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s1">'sass-rails'</span><span class="p">,</span> <span class="s1">'4.0.1'</span>
<span class="n">gem</span> <span class="s1">'uglifier'</span><span class="p">,</span> <span class="s1">'2.1.1'</span>
<span class="n">gem</span> <span class="s1">'coffee-rails'</span><span class="p">,</span> <span class="s1">'4.0.1'</span>
<span class="n">gem</span> <span class="s1">'jquery-rails'</span><span class="p">,</span> <span class="s1">'3.0.4'</span>
<span class="n">gem</span> <span class="s1">'turbolinks'</span><span class="p">,</span> <span class="s1">'1.1.1'</span>
<span class="n">gem</span> <span class="s1">'jbuilder'</span><span class="p">,</span> <span class="s1">'1.0.2'</span>

<span class="n">group</span> <span class="ss">:doc</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sdoc'</span><span class="p">,</span> <span class="s1">'0.3.20'</span><span class="p">,</span> <span class="nb">require</span><span class="p">:</span> <span class="kp">false</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'pg'</span><span class="p">,</span> <span class="s1">'0.15.1'</span>
  <span class="n">gem</span> <span class="s1">'rails_12factor'</span><span class="p">,</span> <span class="s1">'0.0.2'</span>
<span class="k">end</span>
</pre></div></div></div></div><div id="_sec-updating_deleting_exercises" data-tralics-id="cid58" class="section" data-number="9.6"><h2><a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-updating_deleting_exercises" class="heading hyperref"><span class="number">9.6 </span>Exercises</a></h2>
<ol><li>By issuing a <span class="tt">PATCH</span> request directly to the <code>update</code> method as shown in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-forbidden_admin_test" class="hyperref">Listing&nbsp;<span class="ref">9.48</span></a>, verify that the <code>admin</code> attribute isn’t editable through the web.<span class="intersentencespace"></span> Be sure to get first to Red, and then to Green.<span class="intersentencespace"></span> (<em>Hint</em>: Your first step should be to <em>add</em> <code>admin</code> to the list of permitted parameters in <code>user_params</code>.)
</li>
<li>Arrange for the Gravatar “change” link in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-user_edit_view" class="hyperref">Listing&nbsp;<span class="ref">9.3</span></a> to open in a new window (or tab).<span class="intersentencespace"></span> <em>Hint:</em> Search the web; you should find one particularly robust method involving something called <code>_blank</code>.
</li>
<li>The current authentication tests check that navigation links such as “Profile” and “Settings” appear when a user is signed in.<span class="intersentencespace"></span> Add tests to make sure that these links <em>don’t</em> appear when a user isn’t signed in.
</li>
<li>Use the <code>sign_in</code> test helper from <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-sign_in_helper" class="hyperref">Listing&nbsp;<span class="ref">9.6</span></a> in as many places as you can find.
</li>
<li>Remove the duplicated form code by refactoring the <code>new.html.erb</code> and <code>edit.html.erb</code> views to use the partial in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-new_edit_partial" class="hyperref">Listing&nbsp;<span class="ref">9.49</span></a>.<span class="intersentencespace"></span> Note that you will have to pass the form variable&nbsp;<code>f</code> explicitly as a local variable, as shown in <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-new_user_with_partial" class="hyperref">Listing&nbsp;<span class="ref">9.50</span></a>.<span class="intersentencespace"></span> You will also have to update the tests, as the forms aren’t currently <em>exactly</em> the same; identify the slight difference and update the tests accordingly.
</li>
<li>Signed-in users have no reason to access the <code>new</code> and <code>create</code> actions in the Users controller.<span class="intersentencespace"></span> Arrange for such users to be redirected to the root URL if they do try to hit those pages.
</li>
<li>Learn about the <code>request</code> object by inserting some of the methods listed in the <a href="http://api.rubyonrails.org/v4.0.0/classes/ActionDispatch/Request.html">Rails API</a><sup id="_cha-9_footnote-ref-9" class="footnote"><a href="http://www.railstutorial.org/book/updating_and_deleting_users#cha-9_footnote-9">9</a></sup> into the site layout.<span class="intersentencespace"></span> (Refer to <a href="http://www.railstutorial.org/book/sign_up#code-rails_debug" class="hyperref">Listing&nbsp;<span class="ref">7.1</span></a> if you get stuck.)
</li>
<li>Write a test to make sure that the friendly forwarding only forwards to the given URL the first time.<span class="intersentencespace"></span> On subsequent signin attempts, the forwarding URL should revert to the default (i.e., the profile page).<span class="intersentencespace"></span> See <a href="http://www.railstutorial.org/book/updating_and_deleting_users#code-friendly_forgetting_test" class="hyperref">Listing&nbsp;<span class="ref">9.51</span></a> for a hint (and, by a hint, I mean the solution).
</li>
<li>Modify the <code>destroy</code> action to prevent admin users from destroying themselves.<span class="intersentencespace"></span> (Write a test first.)
</li></ol><div class="codelisting" id="_code-forbidden_admin_test" data-tralics-id="uid763" data-number="9.48"><div class="heading"><span class="number">Listing 9.48:</span> 

<span class="description">Testing that the <code>admin</code> attribute is forbidden.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/user_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"edit"</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"forbidden attributes"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:params</span><span class="p">)</span> <span class="k">do</span>
        <span class="p">{</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="ss">admin</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">password</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
                  <span class="n">password_confirmation</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="p">}</span> <span class="p">}</span>
      <span class="k">end</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">sign_in</span> <span class="n">user</span><span class="p">,</span> <span class="n">no_capybara</span><span class="p">:</span> <span class="kp">true</span>
        <span class="n">patch</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="n">params</span>
      <span class="k">end</span>
      <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">be_admin</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-new_edit_partial" data-tralics-id="uid764" data-number="9.49"><div class="heading"><span class="number">Listing 9.49:</span> 

<span class="description">A partial for the new and edit form fields.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/_fields.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">"Confirm Password"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span>
</pre></div></div></div><div class="codelisting" id="_code-new_user_with_partial" data-tralics-id="uid765" data-number="9.50"><div class="heading"><span class="number">Listing 9.50:</span> 

<span class="description">The new user view with partial.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/new.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Sign up'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span6 offset3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'fields'</span><span class="p">,</span> <span class="ss">f</span><span class="p">:</span> <span class="n">f</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Create my account"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-large btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><div class="codelisting" id="_code-friendly_forgetting_test" data-tralics-id="uid766" data-number="9.51"><div class="heading"><span class="number">Listing 9.51:</span> 

<span class="description">A test for forwarding to the default page after friendly forwarding.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"authorization"</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">"for non-signed-in users"</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">"when attempting to visit a protected page"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
          <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>    <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
          <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
          <span class="n">click_button</span> <span class="s2">"Sign in"</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">"after signing in"</span> <span class="k">do</span>

          <span class="n">it</span> <span class="s2">"should render the desired protected page"</span> <span class="k">do</span>
            <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'Edit user'</span><span class="p">)</span>
          <span class="k">end</span>

          <span class="n">describe</span> <span class="s2">"when signing in again"</span> <span class="k">do</span>
            <span class="n">before</span> <span class="k">do</span>
              <span class="n">click_link</span> <span class="s2">"Sign out"</span>
              <span class="n">visit</span> <span class="n">signin_path</span>
              <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>    <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
              <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
              <span class="n">click_button</span> <span class="s2">"Sign in"</span>
            <span class="k">end</span>

            <span class="n">it</span> <span class="s2">"should render the default (profile) page"</span> <span class="k">do</span>
              <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">end</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div></div><div id="cha-9_footnotes">
  <ol class="footnotes"><li id="_cha-9_footnote-1">Image from <a href="http://www.flickr.com/photos/sashawolff/4598355045/">http://www.flickr.com/photos/sashawolff/4598355045/</a>.&nbsp;<a class="arrow" href="http://www.railstutorial.org/book/updating_and_deleting_users#cha-9_footnote-ref-1">↑</a></li>
    <li id="_cha-9_footnote-2">The Gravatar site actually redirects this to <a href="http://en.gravatar.com/emails">http://en.gravatar.com/emails</a>, which is for English language users, but I’ve omitted the <span class="tt">en</span> part to account for the use of other languages.&nbsp;<a class="arrow" href="http://www.railstutorial.org/book/updating_and_deleting_users#cha-9_footnote-ref-2">↑</a></li>
    <li id="_cha-9_footnote-3">Don’t worry about how this works; the details are of interest to developers of the Rails framework itself, and by design are not important for Rails application developers.&nbsp;<a class="arrow" href="http://www.railstutorial.org/book/updating_and_deleting_users#cha-9_footnote-ref-3">↑</a></li>
    <li id="_cha-9_footnote-4">The code in this section is adapted from the <a href="http://github.com/thoughtbot/clearance">Clearance</a> gem by <a href="http://thoughtbot.com/">thoughtbot</a>.&nbsp;<a class="arrow" href="http://www.railstutorial.org/book/updating_and_deleting_users#cha-9_footnote-ref-4">↑</a></li>
    <li id="_cha-9_footnote-5">Thanks to reader Yoel Adler for pointing out this subtle issue, and for discovering the solution.&nbsp;<a class="arrow" href="http://www.railstutorial.org/book/updating_and_deleting_users#cha-9_footnote-ref-5">↑</a></li>
    <li id="_cha-9_footnote-6">Baby photo from <a href="http://www.flickr.com/photos/glasgows/338937124/">http://www.flickr.com/photos/glasgows/338937124/</a>.&nbsp;<a class="arrow" href="http://www.railstutorial.org/book/updating_and_deleting_users#cha-9_footnote-ref-6">↑</a></li>
    <li id="_cha-9_footnote-7">The name <code>user</code> is immaterial—we could have written <code>@users.each do |foobar|</code> and then used <code>render foobar</code>.<span class="intersentencespace"></span> The key is the <em>class</em> of the object—in this case, <code>User</code>.&nbsp;<a class="arrow" href="http://www.railstutorial.org/book/updating_and_deleting_users#cha-9_footnote-ref-7">↑</a></li>
    <li id="_cha-9_footnote-8">Command-line tools such as <span class="tt">curl</span> can issue <span class="tt">PATCH</span> requests of this form.&nbsp;<a class="arrow" href="http://www.railstutorial.org/book/updating_and_deleting_users#cha-9_footnote-ref-8">↑</a></li>
    <li id="_cha-9_footnote-9">http://api.rubyonrails.org/v4.0.0/classes/ActionDispatch/Request.html&nbsp;<a class="arrow" href="http://www.railstutorial.org/book/updating_and_deleting_users#cha-9_footnote-ref-9">↑</a></li>
  </ol></div></div></div>
<div id="bookBottomMenu">
<div class="bookMenuArows">
<a href="javascript://" class="leftArrow">◄</a>
<a href="javascript://" class="upArrow">▲</a>
<a href="javascript://" class="rightArrow">►</a>
</div>
</div>
</div>
<div id="bookContentNotAvailable">
<img alt="Empty_content" src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/empty_content-ccbfa2e7e03ec571f0360d9bdd87eff3.png">
Sorry, content not available
</div>
</div>
<div class="emailPitch" id="bookEmailModal">
<a href="javascript://" class="emailSignupClose" onclick="closeEmailPops()">x</a>
<strong>STAY UP TO DATE!</strong>
<p>Joining the email list for this book will allow the author to contact you to let you know about special offers and when updates for the book are available.</p>
<div class="j_followBookForm"><form accept-charset="UTF-8" action="http://www.softcover.io/follow/28fdb94f/ruby_on_rails_tutorial" method="get"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="✓"></div>
<input name="email" placeholder="YOUR EMAIL ADDRESS" type="text">
<input class="greyButton optClick_follow" type="submit" value="Follow Book">
</form>

</div>
</div>
<script>
  // setup book nav
  Book.init({
    title: "Ruby on Rails Tutorial",
    path: "/book",
    slug: "ruby_on_rails_tutorial",
    s3_path_prefix: "636/ruby_on_rails_tutorial",
    chapters: [{"title":"Frontmatter\n","number":0,"slug":"frontmatter","s3_url":"https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/html/frontmatter_fragment.html?AWSAccessKeyId=AKIAJMNNDDBSYVXVHGAA&Signature=3cznUSXnXrDew9uuhCUMT7uYwZ0%3D&Expires=1407750926"},{"title":"Chapter 1: From zero to deploy\n","number":1,"slug":"beginning","s3_url":"https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/html/beginning_fragment.html?AWSAccessKeyId=AKIAJMNNDDBSYVXVHGAA&Signature=sZfTMuFr3b63EoiZWna3F%2BMeIrc%3D&Expires=1407750926"},{"title":"Chapter 2: A demo app\n","number":2,"slug":"demo_app","s3_url":"https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/html/demo_app_fragment.html?AWSAccessKeyId=AKIAJMNNDDBSYVXVHGAA&Signature=7ypka59z77FORphLOXVxFyKArAg%3D&Expires=1407750926"},{"title":"Chapter 3: Mostly static pages\n","number":3,"slug":"static_pages","s3_url":"https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/html/static_pages_fragment.html?AWSAccessKeyId=AKIAJMNNDDBSYVXVHGAA&Signature=e8thMiKk9Zf/DkL4Kn4v8RtYtmU%3D&Expires=1407750926"},{"title":"Chapter 4: Rails-flavored Ruby\n","number":4,"slug":"rails_flavored_ruby","s3_url":"https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/html/rails_flavored_ruby_fragment.html?AWSAccessKeyId=AKIAJMNNDDBSYVXVHGAA&Signature=oLnkARYLrIH60zp6Gs5sHbaRIn4%3D&Expires=1407750926"},{"title":"Chapter 5: Filling in the layout\n","number":5,"slug":"filling_in_the_layout","s3_url":"https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/html/filling_in_the_layout_fragment.html?AWSAccessKeyId=AKIAJMNNDDBSYVXVHGAA&Signature=uJBin0bm9uO2fIh/yt6QO089cgI%3D&Expires=1407750926"},{"title":"Chapter 6: Modeling users\n","number":6,"slug":"modeling_users","s3_url":"https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/html/modeling_users_fragment.html?AWSAccessKeyId=AKIAJMNNDDBSYVXVHGAA&Signature=DdRzypso57v7ivxJo1KOIgwFPOs%3D&Expires=1407750926"},{"title":"Chapter 7: Sign up\n","number":7,"slug":"sign_up","s3_url":"https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/html/sign_up_fragment.html?AWSAccessKeyId=AKIAJMNNDDBSYVXVHGAA&Signature=yb70PJSy5Ic9bXn7yz//sC8uxNc%3D&Expires=1407750926"},{"title":"Chapter 8: Sign in, sign out\n","number":8,"slug":"sign_in_out","s3_url":"https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/html/sign_in_out_fragment.html?AWSAccessKeyId=AKIAJMNNDDBSYVXVHGAA&Signature=r3RixIR3tCeRF3Ghpas2kIg/nWA%3D&Expires=1407750926"},{"title":"Chapter 9: Updating, showing, and deleting users\n","number":9,"slug":"updating_and_deleting_users","s3_url":"https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/html/updating_and_deleting_users_fragment.html?AWSAccessKeyId=AKIAJMNNDDBSYVXVHGAA&Signature=/V3DsiRsAw12ehSPRXEYYB5uC4g%3D&Expires=1407750926"},{"title":"Chapter 10: User microposts\n","number":10,"slug":"user_microposts","s3_url":"https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/html/user_microposts_fragment.html?AWSAccessKeyId=AKIAJMNNDDBSYVXVHGAA&Signature=/eoswDhFezog7U8GbjcmSZ7SzBw%3D&Expires=1407750926"},{"title":"Chapter 11: Following users\n","number":11,"slug":"following_users","s3_url":"https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/html/following_users_fragment.html?AWSAccessKeyId=AKIAJMNNDDBSYVXVHGAA&Signature=EPhXt%2B9QRV8dzXtAZJJCwd/F0ZM%3D&Expires=1407750926"}],
    full_page: false
  });
</script>

</div>
</div>
<div class="footer clearfix">
<div class="wrapper" id="hide_chromeFooter">
<em>powered by</em>
<a href="http://www.softcover.io/" class="logo"><img alt="Logo_foot" src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/logo_foot-39da4a3be1566a91864f2712656b404e.png">
</a></div>
</div>

<script type="text/javascript">
setTimeout(function(){var a=document.createElement("script");
var b=document.getElementsByTagName("script")[0];
a.src=document.location.protocol+"//dnn506yrbagrg.cloudfront.net/pages/scripts/0023/6713.js?"+Math.floor(new Date().getTime()/3600000);
a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
</script>

<script type="text/javascript">
  var _sf_async_config = { uid: 9895, domain: 'softcover.io', useCanonical: true };
  (function() {
    function loadChartbeat() {
      window._sf_endpt = (new Date()).getTime();
      var e = document.createElement('script');
      e.setAttribute('language', 'javascript');
      e.setAttribute('type', 'text/javascript');
      e.setAttribute('src','//static.chartbeat.com/js/chartbeat.js');
      document.body.appendChild(e);
    };
    var oldonload = window.onload;
    window.onload = (typeof window.onload != 'function') ?
      loadChartbeat : function() { oldonload(); loadChartbeat(); };
  })();
</script>



<script src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/nr-411.min.js"></script><script language="javascript" type="text/javascript" src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/chartbeat.js"></script><script type="text/javascript" src="./Chapter 9  Updating, showing, and deleting users   Ruby on Rails Tutorial   Softcover.io_files/1310fd97f1"></script></body></html>